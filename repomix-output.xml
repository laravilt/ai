This file is a merged representation of a subset of the codebase, containing files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching these patterns are excluded: **/*.log, tmp/, .js, .html, .blade.php, .css, public/, vendor/, node_modules, venv/, logs/, electorn-sentinerl/
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.github/
  ISSUE_TEMPLATE/
    bug.yml
    config.yml
  workflows/
    dependabot-auto-merge.yml
    fix-php-code-styling.yml
    publish.yml
    tests.yml
  CONTRIBUTING.md
  dependabot.yml
  FUNDING.yml
  SECURITY.md
config/
  laravilt-ai.php
database/
  migrations/
    create_ai_sessions_table.php
lang/
  ar/
    ai.php
  en/
    ai.php
resources/
  css/
    app.css
  js/
    components/
      AIChat.vue
      GlobalSearch.vue
    composables/
      useAI.ts
      useGlobalSearch.ts
    pages/
      laravilt/
        AIChat.vue
    app.js
    app.ts
  lang/
    ar/
      ai.php
    en/
      ai.php
routes/
  api.php
  web.php
src/
  Builders/
    AIProviderBuilder.php
    GlobalSearchBuilder.php
  Commands/
    InstallAiCommand.php
  Contracts/
    AIProvider.php
  Enums/
    AnthropicModel.php
    DeepSeekModel.php
    GeminiModel.php
    OpenAIModel.php
    PerplexityModel.php
  Http/
    Controllers/
      AIController.php
      GlobalSearchController.php
  Models/
    AISession.php
  Pages/
    AIChat.php
  Providers/
    AnthropicProvider.php
    BaseProvider.php
    DeepSeekProvider.php
    GeminiProvider.php
    OpenAIProvider.php
    PerplexityProvider.php
  Tools/
    CreateTool.php
    DeleteTool.php
    QueryTool.php
    Tool.php
    UpdateTool.php
  Agent.php
  AIAgent.php
  AIManager.php
  AIServiceProvider.php
  GlobalSearch.php
  ResourceAgent.php
tests/
  Feature/
    AIRoutesTest.php
    DebugTest.php
  Unit/
    Builders/
      AIProviderBuilderTest.php
      GlobalSearchBuilderTest.php
    Enums/
      OpenAIModelTest.php
    Providers/
      OpenAIProviderTest.php
    AIManagerTest.php
    GlobalSearchTest.php
  Pest.php
  TestCase.php
.gitignore
CHANGELOG.md
CODE_OF_CONDUCT.md
composer.json
LICENSE.md
package.json
phpstan.neon
phpunit.xml
pint.json
README.md
testbench.yaml
vite.config.ts
vite.plugin.js
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="resources/js/pages/laravilt/AIChat.vue">
<script setup lang="ts">
import { Head, usePage } from '@inertiajs/vue3';
import { computed, markRaw } from 'vue';
import PanelLayout from '@laravilt/panel/layouts/PanelLayout.vue';
import AIChat from '../../components/AIChat.vue';
import { useLocalization } from '@laravilt/support/composables';

const PanelLayoutRaw = markRaw(PanelLayout);
const { trans } = useLocalization();

interface BreadcrumbItem {
    label: string;
    url: string | null;
}

interface AIConfig {
    configured: boolean;
    default: string;
    providers: Record<string, any>;
}

const props = defineProps<{
    breadcrumbs?: BreadcrumbItem[];
    aiConfig?: AIConfig;
    hasAI?: boolean;
}>();

const page = usePage<{ panel?: { path: string } }>();

// Get the endpoint based on the panel path
const endpoint = computed(() => {
    const panelPath = page.props.panel?.path || 'admin';
    return `/${panelPath}/ai`;
});

// Transform breadcrumbs to frontend format
const transformedBreadcrumbs = computed(() => {
    if (!props.breadcrumbs) return [];
    return props.breadcrumbs.map(item => ({
        title: item.label,
        href: item.url || '#',
    }));
});

const pageTitle = computed(() => trans('laravilt-ai::ai.chat.title'));
</script>

<template>
    <Head :title="pageTitle" />

    <PanelLayoutRaw :breadcrumbs="transformedBreadcrumbs">
        <div class="flex flex-1 flex-col p-4">
            <div class="h-[calc(100vh-12rem)]">
                <AIChat
                    :show-sidebar="true"
                    :endpoint="endpoint"
                />
            </div>
        </div>
    </PanelLayoutRaw>
</template>
</file>

<file path="src/Enums/AnthropicModel.php">
<?php

declare(strict_types=1);

namespace Laravilt\AI\Enums;

enum AnthropicModel: string
{
    case CLAUDE_SONNET_4 = 'claude-sonnet-4-20250514';
    case CLAUDE_OPUS_4 = 'claude-opus-4-20250514';
    case CLAUDE_35_SONNET = 'claude-3-5-sonnet-20241022';
    case CLAUDE_35_HAIKU = 'claude-3-5-haiku-20241022';
    case CLAUDE_3_OPUS = 'claude-3-opus-20240229';
    case CLAUDE_3_SONNET = 'claude-3-sonnet-20240229';
    case CLAUDE_3_HAIKU = 'claude-3-haiku-20240307';

    public function label(): string
    {
        return match ($this) {
            self::CLAUDE_SONNET_4 => 'Claude Sonnet 4',
            self::CLAUDE_OPUS_4 => 'Claude Opus 4',
            self::CLAUDE_35_SONNET => 'Claude 3.5 Sonnet',
            self::CLAUDE_35_HAIKU => 'Claude 3.5 Haiku',
            self::CLAUDE_3_OPUS => 'Claude 3 Opus',
            self::CLAUDE_3_SONNET => 'Claude 3 Sonnet',
            self::CLAUDE_3_HAIKU => 'Claude 3 Haiku',
        };
    }

    /**
     * @return array<string, string>
     */
    public static function toArray(): array
    {
        $models = [];
        foreach (self::cases() as $case) {
            $models[$case->value] = $case->label();
        }

        return $models;
    }
}
</file>

<file path="src/Enums/DeepSeekModel.php">
<?php

declare(strict_types=1);

namespace Laravilt\AI\Enums;

enum DeepSeekModel: string
{
    case DEEPSEEK_CHAT = 'deepseek-chat';
    case DEEPSEEK_CODER = 'deepseek-coder';
    case DEEPSEEK_REASONER = 'deepseek-reasoner';

    public function label(): string
    {
        return match ($this) {
            self::DEEPSEEK_CHAT => 'DeepSeek Chat',
            self::DEEPSEEK_CODER => 'DeepSeek Coder',
            self::DEEPSEEK_REASONER => 'DeepSeek Reasoner (R1)',
        };
    }

    /**
     * @return array<string, string>
     */
    public static function toArray(): array
    {
        $models = [];
        foreach (self::cases() as $case) {
            $models[$case->value] = $case->label();
        }

        return $models;
    }
}
</file>

<file path="src/Enums/GeminiModel.php">
<?php

declare(strict_types=1);

namespace Laravilt\AI\Enums;

enum GeminiModel: string
{
    case GEMINI_2_FLASH = 'gemini-2.0-flash-exp';
    case GEMINI_15_PRO = 'gemini-1.5-pro';
    case GEMINI_15_FLASH = 'gemini-1.5-flash';
    case GEMINI_PRO = 'gemini-pro';

    public function label(): string
    {
        return match ($this) {
            self::GEMINI_2_FLASH => 'Gemini 2.0 Flash',
            self::GEMINI_15_PRO => 'Gemini 1.5 Pro',
            self::GEMINI_15_FLASH => 'Gemini 1.5 Flash',
            self::GEMINI_PRO => 'Gemini Pro',
        };
    }

    /**
     * @return array<string, string>
     */
    public static function toArray(): array
    {
        $models = [];
        foreach (self::cases() as $case) {
            $models[$case->value] = $case->label();
        }

        return $models;
    }
}
</file>

<file path="src/Enums/OpenAIModel.php">
<?php

declare(strict_types=1);

namespace Laravilt\AI\Enums;

enum OpenAIModel: string
{
    case GPT_4O = 'gpt-4o';
    case GPT_4O_MINI = 'gpt-4o-mini';
    case GPT_4_TURBO = 'gpt-4-turbo';
    case GPT_4 = 'gpt-4';
    case GPT_35_TURBO = 'gpt-3.5-turbo';
    case O1 = 'o1';
    case O1_MINI = 'o1-mini';
    case O1_PREVIEW = 'o1-preview';

    public function label(): string
    {
        return match ($this) {
            self::GPT_4O => 'GPT-4o',
            self::GPT_4O_MINI => 'GPT-4o Mini',
            self::GPT_4_TURBO => 'GPT-4 Turbo',
            self::GPT_4 => 'GPT-4',
            self::GPT_35_TURBO => 'GPT-3.5 Turbo',
            self::O1 => 'O1',
            self::O1_MINI => 'O1 Mini',
            self::O1_PREVIEW => 'O1 Preview',
        };
    }

    /**
     * @return array<string, string>
     */
    public static function toArray(): array
    {
        $models = [];
        foreach (self::cases() as $case) {
            $models[$case->value] = $case->label();
        }

        return $models;
    }
}
</file>

<file path="src/Enums/PerplexityModel.php">
<?php

declare(strict_types=1);

namespace Laravilt\AI\Enums;

enum PerplexityModel: string
{
    case SONAR = 'sonar';
    case SONAR_PRO = 'sonar-pro';
    case SONAR_REASONING = 'sonar-reasoning';
    case SONAR_REASONING_PRO = 'sonar-reasoning-pro';

    public function label(): string
    {
        return match ($this) {
            self::SONAR => 'Sonar',
            self::SONAR_PRO => 'Sonar Pro',
            self::SONAR_REASONING => 'Sonar Reasoning',
            self::SONAR_REASONING_PRO => 'Sonar Reasoning Pro',
        };
    }

    /**
     * @return array<string, string>
     */
    public static function toArray(): array
    {
        $models = [];
        foreach (self::cases() as $case) {
            $models[$case->value] = $case->label();
        }

        return $models;
    }
}
</file>

<file path="src/Pages/AIChat.php">
<?php

declare(strict_types=1);

namespace Laravilt\AI\Pages;

use Laravilt\Panel\Pages\Page;

class AIChat extends Page
{
    protected static ?string $title = null;

    protected static ?string $navigationIcon = 'Sparkles';

    protected static ?string $slug = 'ai';

    protected static string $view = 'laravilt/AIChat';

    /**
     * Don't show in sidebar navigation.
     */
    protected static bool $shouldRegisterNavigation = false;

    public static function getTitle(): string
    {
        return static::$title ?? __('laravilt-ai::ai.chat.title');
    }

    public static function getLabel(): string
    {
        return __('laravilt-ai::ai.chat.title');
    }

    /**
     * Get breadcrumbs for AI Chat page.
     */
    public function getBreadcrumbs(): array
    {
        return [
            [
                'label' => __('laravilt-panel::panel.navigation.dashboard'),
                'url' => $this->getPanel()->url('/'),
            ],
            [
                'label' => static::getTitle(),
                'url' => null,
            ],
        ];
    }

    /**
     * Get extra props for Inertia response.
     */
    protected function getInertiaProps(): array
    {
        $panel = $this->getPanel();

        return [
            'aiConfig' => $panel->getAIConfig(),
            'hasAI' => $panel->hasAIProviders(),
        ];
    }
}
</file>

<file path="src/Providers/PerplexityProvider.php">
<?php

declare(strict_types=1);

namespace Laravilt\AI\Providers;

use Generator;
use Laravilt\AI\Enums\PerplexityModel;

class PerplexityProvider extends BaseProvider
{
    public function getName(): string
    {
        return 'perplexity';
    }

    public function getLabel(): string
    {
        return 'Perplexity';
    }

    public function getModels(): array
    {
        return PerplexityModel::toArray();
    }

    public function getDefaultModel(): string
    {
        return PerplexityModel::SONAR->value;
    }

    protected function getBaseUrl(): string
    {
        return 'https://api.perplexity.ai';
    }

    protected function getHeaders(): array
    {
        return [
            'Authorization' => 'Bearer '.$this->getApiKey(),
            'Content-Type' => 'application/json',
        ];
    }

    public function chat(array $messages, array $options = []): array
    {
        $response = $this->http()->post('/chat/completions', [
            'model' => $options['model'] ?? $this->getModel(),
            'messages' => $messages,
            'temperature' => $options['temperature'] ?? $this->getTemperature(),
            'max_tokens' => $options['max_tokens'] ?? $this->getMaxTokens(),
        ]);

        $data = $response->json();

        return [
            'content' => $data['choices'][0]['message']['content'] ?? '',
            'citations' => $data['citations'] ?? [],
            'usage' => [
                'prompt_tokens' => $data['usage']['prompt_tokens'] ?? 0,
                'completion_tokens' => $data['usage']['completion_tokens'] ?? 0,
                'total_tokens' => $data['usage']['total_tokens'] ?? 0,
            ],
        ];
    }

    public function chatWithTools(array $messages, array $tools, array $options = []): array
    {
        // Perplexity doesn't support tools, fall back to regular chat
        $result = $this->chat($messages, $options);

        return [
            'content' => $result['content'],
            'tool_calls' => null,
            'citations' => $result['citations'] ?? [],
            'usage' => $result['usage'],
        ];
    }

    public function streamChat(array $messages, array $options = []): Generator
    {
        $response = $this->http()->withOptions(['stream' => true])
            ->post('/chat/completions', [
                'model' => $options['model'] ?? $this->getModel(),
                'messages' => $messages,
                'temperature' => $options['temperature'] ?? $this->getTemperature(),
                'max_tokens' => $options['max_tokens'] ?? $this->getMaxTokens(),
                'stream' => true,
            ]);

        $body = $response->toPsrResponse()->getBody();

        while (! $body->eof()) {
            $line = $this->readLine($body);
            if (str_starts_with($line, 'data: ')) {
                $data = substr($line, 6);
                if ($data === '[DONE]') {
                    break;
                }
                $json = json_decode($data, true);
                if (isset($json['choices'][0]['delta']['content'])) {
                    yield $json['choices'][0]['delta']['content'];
                }
            }
        }
    }

    /**
     * @param  \Psr\Http\Message\StreamInterface  $stream
     */
    private function readLine($stream): string
    {
        $line = '';
        while (! $stream->eof()) {
            $char = $stream->read(1);
            if ($char === "\n") {
                break;
            }
            $line .= $char;
        }

        return trim($line);
    }
}
</file>

<file path="tests/Feature/AIRoutesTest.php">
<?php

use Illuminate\Foundation\Testing\RefreshDatabase;

describe('AI Routes', function () {
    it('ai config endpoint returns json', function () {
        // This test requires full panel setup with routes registered
        // For now, we verify the endpoint structure exists in config
        expect(config('laravilt-ai.providers'))->toBeArray();
    });

    it('can load translations', function () {
        expect(__('laravilt-ai::ai.chat.title'))->toBe('AI Chat');
        expect(__('laravilt-ai::ai.chat.new_chat'))->toBe('New Chat');
    });

    it('can load arabic translations', function () {
        app()->setLocale('ar');

        expect(__('laravilt-ai::ai.chat.title'))->toBe('محادثة الذكاء الاصطناعي');
        expect(__('laravilt-ai::ai.chat.new_chat'))->toBe('محادثة جديدة');
    });

    it('can load search translations', function () {
        expect(__('laravilt-ai::ai.search.placeholder'))->toBe('Search...');
        expect(__('laravilt-ai::ai.search.no_results'))->toBe('No results found');
    });

    it('can load arabic search translations', function () {
        app()->setLocale('ar');

        expect(__('laravilt-ai::ai.search.placeholder'))->toBe('بحث...');
        expect(__('laravilt-ai::ai.search.no_results'))->toBe('لا توجد نتائج');
    });
});
</file>

<file path="tests/Unit/Builders/AIProviderBuilderTest.php">
<?php

use Laravilt\AI\Builders\AIProviderBuilder;
use Laravilt\AI\Providers\OpenAIProvider;
use Laravilt\AI\Providers\AnthropicProvider;
use Laravilt\AI\Enums\OpenAIModel;

describe('AIProviderBuilder', function () {
    beforeEach(function () {
        $this->builder = new AIProviderBuilder;
    });

    it('can add a provider', function () {
        $this->builder->provider(OpenAIProvider::class, function (OpenAIProvider $provider) {
            $provider->apiKey('test-key');
        });

        expect($this->builder->getProviders())->toHaveCount(1);
    });

    it('can add multiple providers', function () {
        $this->builder->provider(OpenAIProvider::class, function (OpenAIProvider $provider) {
            $provider->apiKey('test-key');
        });

        $this->builder->provider(AnthropicProvider::class, function (AnthropicProvider $provider) {
            $provider->apiKey('another-key');
        });

        expect($this->builder->getProviders())->toHaveCount(2);
    });

    it('can set default provider', function () {
        $this->builder->provider(OpenAIProvider::class, function (OpenAIProvider $provider) {
            $provider->apiKey('test-key');
        })->default('openai');

        expect($this->builder->getDefaultProviderName())->toBe('openai');
    });

    it('can check if has configured providers', function () {
        expect($this->builder->hasConfiguredProviders())->toBeFalse();

        $this->builder->provider(OpenAIProvider::class, function (OpenAIProvider $provider) {
            $provider->apiKey('test-key');
        });

        expect($this->builder->hasConfiguredProviders())->toBeTrue();
    });

    it('can convert to array', function () {
        $this->builder->provider(OpenAIProvider::class, function (OpenAIProvider $provider) {
            $provider->apiKey('test-key');
        })->default('openai');

        $array = $this->builder->toArray();

        expect($array)->toHaveKeys(['providers', 'defaultProvider']);
        expect($array['defaultProvider'])->toBe('openai');
    });

    it('can configure provider with enum model', function () {
        $this->builder->provider(OpenAIProvider::class, function (OpenAIProvider $provider) {
            $provider
                ->apiKey('test-key')
                ->model(OpenAIModel::GPT_4O);
        });

        expect($this->builder->getProviders())->toHaveCount(1);
    });

    it('can get provider by name', function () {
        $this->builder->provider(OpenAIProvider::class, function (OpenAIProvider $provider) {
            $provider->apiKey('test-key');
        });

        $provider = $this->builder->getProvider('openai');

        expect($provider)->toBeInstanceOf(OpenAIProvider::class);
    });

    it('has shorthand methods for common providers', function () {
        $this->builder
            ->openai(fn ($p) => $p->apiKey('test'))
            ->anthropic(fn ($p) => $p->apiKey('test'))
            ->gemini(fn ($p) => $p->apiKey('test'))
            ->deepseek(fn ($p) => $p->apiKey('test'))
            ->perplexity(fn ($p) => $p->apiKey('test'));

        expect($this->builder->getProviders())->toHaveCount(5);
    });
});
</file>

<file path="tests/Unit/Builders/GlobalSearchBuilderTest.php">
<?php

use Laravilt\AI\Builders\GlobalSearchBuilder;

describe('GlobalSearchBuilder', function () {
    beforeEach(function () {
        $this->builder = new GlobalSearchBuilder;
    });

    it('is enabled by default', function () {
        expect($this->builder->isEnabled())->toBeTrue();
    });

    it('can be disabled', function () {
        $this->builder->disabled();

        expect($this->builder->isEnabled())->toBeFalse();
    });

    it('can be enabled with condition', function () {
        $this->builder->enabled(false);

        expect($this->builder->isEnabled())->toBeFalse();
    });

    it('can set limit', function () {
        $this->builder->limit(10);

        expect($this->builder->getLimit())->toBe(10);
    });

    it('has default limit of 5', function () {
        expect($this->builder->getLimit())->toBe(5);
    });

    it('can set debounce', function () {
        $this->builder->debounce(500);

        expect($this->builder->getDebounce())->toBe(500);
    });

    it('has default debounce of 300', function () {
        expect($this->builder->getDebounce())->toBe(300);
    });

    it('can enable AI', function () {
        $this->builder->withAI();

        expect($this->builder->usesAI())->toBeTrue();
    });

    it('AI is disabled by default', function () {
        expect($this->builder->usesAI())->toBeFalse();
    });

    it('can set custom endpoint', function () {
        $this->builder->endpoint('/custom-search');

        expect($this->builder->getEndpoint())->toBe('/custom-search');
    });

    it('can exclude resources', function () {
        $this->builder->exclude(['UserResource', 'PostResource']);

        expect($this->builder->getExcludedResources())->toContain('UserResource', 'PostResource');
    });

    it('can set shortcut', function () {
        $this->builder->shortcut('ctrl+k');

        expect($this->builder->getShortcut())->toBe('ctrl+k');
    });

    it('has default shortcut', function () {
        expect($this->builder->getShortcut())->toBe('cmd+k');
    });

    it('can convert to array', function () {
        $this->builder
            ->enabled()
            ->limit(10)
            ->debounce(500)
            ->withAI();

        $array = $this->builder->toArray();

        expect($array)->toHaveKeys(['enabled', 'limit', 'debounce', 'useAI', 'endpoint']);
        expect($array['enabled'])->toBeTrue();
        expect($array['limit'])->toBe(10);
        expect($array['debounce'])->toBe(500);
        expect($array['useAI'])->toBeTrue();
    });
});
</file>

<file path="tests/Unit/Enums/OpenAIModelTest.php">
<?php

use Laravilt\AI\Enums\OpenAIModel;

describe('OpenAIModel Enum', function () {
    it('has correct values', function () {
        expect(OpenAIModel::GPT_4O->value)->toBe('gpt-4o');
        expect(OpenAIModel::GPT_4O_MINI->value)->toBe('gpt-4o-mini');
        expect(OpenAIModel::GPT_4_TURBO->value)->toBe('gpt-4-turbo');
        expect(OpenAIModel::GPT_4->value)->toBe('gpt-4');
        expect(OpenAIModel::GPT_35_TURBO->value)->toBe('gpt-3.5-turbo');
    });

    it('has correct labels', function () {
        expect(OpenAIModel::GPT_4O->label())->toBe('GPT-4o');
        expect(OpenAIModel::GPT_4O_MINI->label())->toBe('GPT-4o Mini');
        expect(OpenAIModel::GPT_35_TURBO->label())->toBe('GPT-3.5 Turbo');
    });

    it('can convert to array', function () {
        $array = OpenAIModel::toArray();

        expect($array)->toBeArray();
        expect($array)->toHaveKey('gpt-4o');
        expect($array)->toHaveKey('gpt-4o-mini');
        expect($array['gpt-4o'])->toBe('GPT-4o');
    });

    it('can get all cases', function () {
        $cases = OpenAIModel::cases();

        expect($cases)->toBeArray();
        expect(count($cases))->toBeGreaterThan(0);
    });

    it('includes O1 models', function () {
        expect(OpenAIModel::O1->value)->toBe('o1');
        expect(OpenAIModel::O1_MINI->value)->toBe('o1-mini');
        expect(OpenAIModel::O1_PREVIEW->value)->toBe('o1-preview');
    });
});
</file>

<file path="tests/Unit/Providers/OpenAIProviderTest.php">
<?php

use Laravilt\AI\Providers\OpenAIProvider;
use Laravilt\AI\Enums\OpenAIModel;

describe('OpenAIProvider', function () {
    beforeEach(function () {
        $this->provider = new OpenAIProvider;
    });

    it('has correct name', function () {
        expect($this->provider->getName())->toBe('openai');
    });

    it('has correct label', function () {
        expect($this->provider->getLabel())->toBe('OpenAI');
    });

    it('can set api key', function () {
        $this->provider->apiKey('test-api-key');

        expect($this->provider->isConfigured())->toBeTrue();
    });

    it('is not configured without api key', function () {
        // Create a fresh provider without config
        config()->set('laravilt-ai.providers.openai.api_key', null);
        $provider = new OpenAIProvider;

        expect($provider->isConfigured())->toBeFalse();
    });

    it('can set model using enum (fluent api)', function () {
        $result = $this->provider->model(OpenAIModel::GPT_4O);

        expect($result)->toBeInstanceOf(OpenAIProvider::class);
    });

    it('can set model using string (fluent api)', function () {
        $result = $this->provider->model('gpt-4-turbo');

        expect($result)->toBeInstanceOf(OpenAIProvider::class);
    });

    it('has default model', function () {
        expect($this->provider->getDefaultModel())->toBe('gpt-4o-mini');
    });

    it('can get available models', function () {
        $models = $this->provider->getModels();

        expect($models)->toBeArray();
        expect($models)->toHaveKey('gpt-4o');
        expect($models)->toHaveKey('gpt-4o-mini');
    });

    it('can set temperature (fluent api)', function () {
        $result = $this->provider->temperature(0.5);

        expect($result)->toBeInstanceOf(OpenAIProvider::class);
    });

    it('can set max tokens (fluent api)', function () {
        $result = $this->provider->maxTokens(2000);

        expect($result)->toBeInstanceOf(OpenAIProvider::class);
    });

    it('can convert to array', function () {
        $this->provider->apiKey('test-key');

        $array = $this->provider->toArray();

        expect($array)->toHaveKeys(['name', 'label', 'models', 'defaultModel', 'configured']);
        expect($array['name'])->toBe('openai');
        expect($array['configured'])->toBeTrue();
    });

    it('loads config from laravilt-ai config file', function () {
        config()->set('laravilt-ai.providers.openai', [
            'api_key' => 'config-api-key',
            'model' => 'gpt-4-turbo',
            'temperature' => 0.7,
        ]);

        $provider = new OpenAIProvider;

        expect($provider->isConfigured())->toBeTrue();
    });

    it('can be enabled and disabled', function () {
        expect($this->provider->isEnabled())->toBeTrue();

        $this->provider->disabled();
        expect($this->provider->isEnabled())->toBeFalse();

        $this->provider->enabled();
        expect($this->provider->isEnabled())->toBeTrue();
    });
});
</file>

<file path="tests/Unit/AIManagerTest.php">
<?php

use Laravilt\AI\AIManager;
use Laravilt\AI\Providers\OpenAIProvider;

describe('AIManager', function () {
    beforeEach(function () {
        $this->manager = new AIManager;
    });

    it('can add a provider', function () {
        $provider = new OpenAIProvider;
        $provider->apiKey('test-key');
        $this->manager->addProvider($provider);

        expect($this->manager->hasProvider('openai'))->toBeTrue();
    });

    it('can set default provider', function () {
        $provider = new OpenAIProvider;
        $provider->apiKey('test-key');
        $this->manager->addProvider($provider);
        $this->manager->setDefaultProvider('openai');

        expect($this->manager->provider())->toBe($provider);
    });

    it('can check if provider exists', function () {
        $provider = new OpenAIProvider;
        $provider->apiKey('test-key');
        $this->manager->addProvider($provider);

        expect($this->manager->hasProvider('openai'))->toBeTrue();
        expect($this->manager->hasProvider('nonexistent'))->toBeFalse();
    });

    it('can get all providers', function () {
        $provider = new OpenAIProvider;
        $provider->apiKey('test-key');
        $this->manager->addProvider($provider);

        expect($this->manager->getProviders())->toHaveCount(1);
    });

    it('can convert to array for frontend', function () {
        $provider = new OpenAIProvider;
        $provider->apiKey('test-key');
        $this->manager->addProvider($provider);
        $this->manager->setDefaultProvider('openai');

        $array = $this->manager->toArray();

        expect($array)->toHaveKeys(['configured', 'default', 'providers']);
        expect($array['default'])->toBe('openai');
        expect($array['providers'])->toHaveKey('openai');
    });

    it('reports configured status', function () {
        // Clear existing config to test unconfigured state
        config()->set('laravilt-ai.providers.openai.api_key', null);
        $freshManager = new AIManager;

        expect($freshManager->isConfigured())->toBeFalse();

        $provider = new OpenAIProvider;
        $provider->apiKey('test-key');
        $freshManager->addProvider($provider);

        expect($freshManager->isConfigured())->toBeTrue();
    });
});
</file>

<file path="tests/Unit/GlobalSearchTest.php">
<?php

use Laravilt\AI\GlobalSearch;

describe('GlobalSearch', function () {
    beforeEach(function () {
        $this->search = new GlobalSearch;
    });

    it('can register a resource', function () {
        $result = $this->search->registerResource(
            resource: 'users',
            model: \Illuminate\Foundation\Auth\User::class,
            searchable: ['name', 'email'],
            label: 'Users',
            icon: 'Users',
            url: '/admin/users/{id}'
        );

        expect($result)->toBeInstanceOf(GlobalSearch::class);
    });

    it('can set limit', function () {
        $result = $this->search->limit(10);

        expect($result)->toBeInstanceOf(GlobalSearch::class);
    });

    it('can enable/disable AI', function () {
        $result = $this->search->useAI(true);

        expect($result)->toBeInstanceOf(GlobalSearch::class);
    });

    it('returns empty collection for empty query', function () {
        $results = $this->search->search('');

        expect($results)->toBeInstanceOf(\Illuminate\Support\Collection::class);
        expect($results)->toBeEmpty();
    });

    it('returns empty collection for whitespace query', function () {
        $results = $this->search->search('   ');

        expect($results)->toBeInstanceOf(\Illuminate\Support\Collection::class);
        expect($results)->toBeEmpty();
    });
});
</file>

<file path=".github/ISSUE_TEMPLATE/bug.yml">
name: Bug Report
description: Report a bug
title: "[Bug]: "
labels: ["bug"]
body:
  - type: markdown
    attributes:
      value: |
        Thanks for taking the time to fill out this bug report!
  - type: textarea
    id: description
    attributes:
      label: Description
      description: A clear and concise description of the bug
    validations:
      required: true
  - type: textarea
    id: steps
    attributes:
      label: Steps to Reproduce
      description: Steps to reproduce the behavior
      placeholder: |
        1. Go to '...'
        2. Click on '....'
        3. See error
    validations:
      required: true
  - type: textarea
    id: expected
    attributes:
      label: Expected Behavior
      description: What you expected to happen
    validations:
      required: true
  - type: textarea
    id: actual
    attributes:
      label: Actual Behavior
      description: What actually happened
    validations:
      required: true
  - type: input
    id: version
    attributes:
      label: Package Version
      description: What version of the package are you using?
    validations:
      required: true
  - type: input
    id: php-version
    attributes:
      label: PHP Version
      description: What version of PHP are you using?
    validations:
      required: true
  - type: input
    id: laravel-version
    attributes:
      label: Laravel Version
      description: What version of Laravel are you using?
    validations:
      required: true
</file>

<file path=".github/ISSUE_TEMPLATE/config.yml">
blank_issues_enabled: false
contact_links:
  - name: Ask a question
    url: https://github.com/laravilt/ai/discussions/new?category=q-a
    about: Ask the community for help
  - name: Request a feature
    url: https://github.com/laravilt/ai/discussions/new?category=ideas
    about: Share ideas for new features
</file>

<file path=".github/workflows/dependabot-auto-merge.yml">
name: Dependabot Auto-Merge

on: [push, pull_request]

permissions:
  pull-requests: write
  contents: write

jobs:
  dependabot:
    runs-on: ubuntu-latest
    if: ${{ github.actor == 'dependabot[bot]' }}
    steps:
      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Auto-merge Dependabot PRs for semver-minor updates
        if: ${{steps.metadata.outputs.update-type == 'version-update:semver-minor'}}
        run: gh pr merge --auto --merge "$PR_URL"
        env:
          PR_URL: ${{github.event.pull_request.html_url}}
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

      - name: Auto-merge Dependabot PRs for semver-patch updates
        if: ${{steps.metadata.outputs.update-type == 'version-update:semver-patch'}}
        run: gh pr merge --auto --merge "$PR_URL"
        env:
          PR_URL: ${{github.event.pull_request.html_url}}
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
</file>

<file path=".github/workflows/fix-php-code-styling.yml">
name: Fix PHP Code Styling

on:
  push:
    branches: [ "master", "main" ]

permissions:
  contents: write

jobs:
  php-code-styling:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Fix PHP code style issues
        uses: aglipanci/laravel-pint-action@2.4
        with:
          preset: laravel

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: Fix styling
</file>

<file path=".github/workflows/publish.yml">
name: Publish to NPM

on:
  push:
    branches:
      - master
      - main
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js for npm
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          scope: '@laravilt'

      - name: Configure npm authentication
        run: |
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> ~/.npmrc
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" >> ~/.npmrc

      - name: Install dependencies
        run: npm install

      - name: Bump version (if manual trigger)
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          npm version ${{ github.event.inputs.version_bump }} --no-git-tag-version
          git add package.json
          git commit -m "chore: bump version to $(node -p "require('./package.json').version")"
          git push origin HEAD:${{ github.ref_name }}

      - name: Build package
        run: npm run build:npm

      - name: Publish to npm registry
        if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > .npmrc
          echo "registry=https://registry.npmjs.org/" >> .npmrc
          npm publish --access public

      - name: Publish to GitHub Packages
        if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
        run: |
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" > .npmrc
          echo "registry=https://npm.pkg.github.com/" >> .npmrc
          echo "@laravilt:registry=https://npm.pkg.github.com/" >> .npmrc
          npm publish

      - name: Get package info
        id: package_info
        run: |
          echo "name=$(node -p "require('./package.json').name")" >> $GITHUB_OUTPUT
          echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.package_info.outputs.version }}
          name: v${{ steps.package_info.outputs.version }}
          body: |
            ## ${{ steps.package_info.outputs.name }} v${{ steps.package_info.outputs.version }}

            Published to npm: https://www.npmjs.com/package/${{ steps.package_info.outputs.name }}

            Install with:
            ```bash
            npm install ${{ steps.package_info.outputs.name }}@${{ steps.package_info.outputs.version }}
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Push version tag (if manual trigger)
        if: github.event_name == 'workflow_dispatch'
        run: |
          git tag "v${{ steps.package_info.outputs.version }}"
          git push origin --tags
</file>

<file path=".github/workflows/tests.yml">
name: Tests

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        php: [8.2, 8.3]
        laravel: [11.*]
        dependency-version: [prefer-stable]

    name: PHP ${{ matrix.php }} - Laravel ${{ matrix.laravel }} - ${{ matrix.dependency-version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv
          coverage: none

      - name: Setup problem matchers
        run: |
          echo "::add-matcher::${{ runner.tool_cache }}/php.json"
          echo "::add-matcher::${{ runner.tool_cache }}/phpunit.json"

      - name: Install dependencies
        run: |
          composer require "laravel/framework:${{ matrix.laravel }}" --no-interaction --no-update
          composer update --${{ matrix.dependency-version }} --prefer-dist --no-interaction

      - name: Execute tests
        run: vendor/bin/pest
</file>

<file path=".github/CONTRIBUTING.md">
# Contributing to Ai

Thank you for considering contributing to Ai!

## Pull Requests

1. Fork the repository
2. Create a new branch for your feature
3. Write tests for your changes
4. Ensure all tests pass
5. Submit a pull request

## Coding Standards

- Follow PSR-12 coding standards
- Run `composer format` before committing
- Write tests for new features
- Ensure PHPStan passes with level 5

## Running Tests

```bash
composer test
```

## Code Style

```bash
composer format
```

## Static Analysis

```bash
composer analyse
```
</file>

<file path=".github/dependabot.yml">
version: 2
updates:
  - package-ecosystem: "composer"
    directory: "/"
    schedule:
      interval: "weekly"
    open-pull-requests-limit: 10

  - package-ecosystem: "github-actions"
    directory: "/"
    schedule:
      interval: "weekly"
</file>

<file path=".github/FUNDING.yml">
github: fadymondy
</file>

<file path=".github/SECURITY.md">
# Security Policy

## Reporting a Vulnerability

If you discover a security vulnerability within Ai, please send an email to info@3x1.io. All security vulnerabilities will be promptly addressed.

Please do not publicly disclose the issue until it has been addressed by the team.
</file>

<file path="database/migrations/create_ai_sessions_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('ai_sessions', function (Blueprint $table) {
            $table->uuid('id')->primary();
            $table->foreignId('user_id')->nullable()->constrained()->cascadeOnDelete();
            $table->string('title')->default('New Chat');
            $table->string('provider')->nullable();
            $table->string('model')->nullable();
            $table->json('messages')->nullable();
            $table->json('metadata')->nullable();
            $table->timestamps();

            $table->index(['user_id', 'updated_at']);
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('ai_sessions');
    }
};
</file>

<file path="lang/ar/ai.php">
<?php

return [
    /*
    |--------------------------------------------------------------------------
    | Ai Language Lines
    |--------------------------------------------------------------------------
    |
    | The following language lines are used by the Ai plugin.
    | You are free to modify these language lines according to your
    | application's requirements.
    |
    */

    // Add your translation messages here
];
</file>

<file path="lang/en/ai.php">
<?php

return [
    /*
    |--------------------------------------------------------------------------
    | Ai Language Lines
    |--------------------------------------------------------------------------
    |
    | The following language lines are used by the Ai plugin.
    | You are free to modify these language lines according to your
    | application's requirements.
    |
    */

    // Add your translation messages here
];
</file>

<file path="resources/css/app.css">
@import "tailwindcss";

/**
 * Ai Styles
 *
 * Custom theme configuration for Tailwind CSS v4
 *
 * @theme {
 *   --color-primary: oklch(0.72 0.11 178);
 *   --color-secondary: oklch(0.65 0.15 250);
 * }
 */
</file>

<file path="resources/js/components/AIChat.vue">
<script setup lang="ts">
import { ref, computed, watch, nextTick, onMounted } from 'vue'
import { usePage } from '@inertiajs/vue3'
import {
  Send,
  Loader2,
  Bot,
  User,
  Plus,
  Trash2,
  Settings2,
  Copy,
  Check,
  Sparkles,
  PanelLeftClose,
  PanelLeft,
  MoreHorizontal,
  Pencil,
  MessageSquare,
} from 'lucide-vue-next'
import { Button } from '@/components/ui/button'
import { ScrollArea } from '@/components/ui/scroll-area'
import { Textarea } from '@/components/ui/textarea'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu'
import { useLocalization } from '@laravilt/support/composables'

interface Message {
  role: 'system' | 'user' | 'assistant'
  content: string
  timestamp?: number
}

interface Session {
  id: string
  title: string
  provider?: string
  model?: string
  messages: Message[]
  created_at: string
  updated_at: string
}

interface Provider {
  name: string
  label: string
  models: Record<string, string>
  defaultModel: string
  configured: boolean
}

interface AIConfig {
  configured: boolean
  default: string
  providers: Record<string, Provider>
}

const props = withDefaults(
  defineProps<{
    initialSession?: Session
    showSidebar?: boolean
    endpoint?: string
  }>(),
  {
    showSidebar: true,
    endpoint: '/laravilt-ai',
  }
)

const emit = defineEmits<{
  (e: 'sessionChange', session: Session): void
}>()

const { trans } = useLocalization()
const page = usePage()

// State
const config = ref<AIConfig | null>(null)
const sessions = ref<Session[]>([])
const currentSession = ref<Session | null>(props.initialSession || null)
const messages = ref<Message[]>([])
const input = ref('')
const loading = ref(false)
const streaming = ref(false)
const configLoading = ref(true)
const sidebarOpen = ref(true)

const selectedProvider = ref<string>('')
const selectedModel = ref<string>('')

const chatContainerRef = ref<HTMLElement | null>(null)
const inputRef = ref<HTMLTextAreaElement | null>(null)
const copiedMessageIndex = ref<number | null>(null)

// Get CSRF token
const csrfToken = computed(() => {
  return (page.props as any).csrf_token || document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
})

// Computed
const availableProviders = computed(() => {
  if (!config.value) return []
  return Object.entries(config.value.providers)
    .filter(([, p]) => p.configured)
    .map(([key, p]) => ({ key, ...p }))
})

const availableModels = computed(() => {
  if (!config.value || !selectedProvider.value) return []
  const provider = config.value.providers[selectedProvider.value]
  if (!provider) return []
  return Object.entries(provider.models).map(([key, label]) => ({ key, label }))
})

const canSend = computed(() => {
  return input.value.trim() && !loading.value && config.value?.configured
})

const currentProviderLabel = computed(() => {
  if (!selectedProvider.value || !config.value) return ''
  return config.value.providers[selectedProvider.value]?.label || selectedProvider.value
})

const currentModelLabel = computed(() => {
  if (!selectedModel.value || !selectedProvider.value || !config.value) return ''
  const provider = config.value.providers[selectedProvider.value]
  return provider?.models[selectedModel.value] || selectedModel.value
})

// Load config
async function loadConfig() {
  try {
    const response = await fetch(`${props.endpoint}/config`, {
      headers: {
        'Accept': 'application/json',
        'X-CSRF-TOKEN': csrfToken.value,
      },
      credentials: 'same-origin',
    })
    config.value = await response.json()

    if (config.value?.default) {
      selectedProvider.value = config.value.default
      const provider = config.value.providers[config.value.default]
      if (provider) {
        selectedModel.value = provider.defaultModel
      }
    }
  } catch (error) {
    console.error('Failed to load AI config:', error)
  } finally {
    configLoading.value = false
  }
}

// Load sessions
async function loadSessions() {
  try {
    const response = await fetch(`${props.endpoint}/sessions`, {
      headers: {
        'Accept': 'application/json',
        'X-CSRF-TOKEN': csrfToken.value,
      },
      credentials: 'same-origin',
    })
    const data = await response.json()
    sessions.value = data.sessions || []
  } catch (error) {
    console.error('Failed to load sessions:', error)
  }
}

// Create new session
async function createSession() {
  currentSession.value = null
  messages.value = []
  input.value = ''
  inputRef.value?.focus()
}

// Load session
async function loadSession(session: Session) {
  currentSession.value = session
  messages.value = session.messages || []
  selectedProvider.value = session.provider || selectedProvider.value
  selectedModel.value = session.model || selectedModel.value
  emit('sessionChange', session)
  await nextTick()
  scrollToBottom()
}

// Delete session
async function deleteSession(sessionId: string) {
  try {
    await fetch(`${props.endpoint}/sessions/${sessionId}`, {
      method: 'DELETE',
      headers: {
        'Accept': 'application/json',
        'X-CSRF-TOKEN': csrfToken.value,
      },
      credentials: 'same-origin',
    })
    sessions.value = sessions.value.filter((s) => s.id !== sessionId)
    if (currentSession.value?.id === sessionId) {
      currentSession.value = null
      messages.value = []
    }
  } catch (error) {
    console.error('Failed to delete session:', error)
  }
}

// Send message
async function sendMessage() {
  if (!canSend.value) return

  const userMessage: Message = {
    role: 'user',
    content: input.value.trim(),
    timestamp: Date.now(),
  }

  messages.value.push(userMessage)
  const userInput = input.value
  input.value = ''
  loading.value = true

  // Reset textarea height
  if (inputRef.value) {
    inputRef.value.style.height = 'auto'
  }

  await nextTick()
  scrollToBottom()

  try {
    const response = await fetch(`${props.endpoint}/chat`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'X-CSRF-TOKEN': csrfToken.value,
      },
      credentials: 'same-origin',
      body: JSON.stringify({
        messages: messages.value.map((m) => ({ role: m.role, content: m.content })),
        provider: selectedProvider.value,
        model: selectedModel.value,
        session_id: currentSession.value?.id,
      }),
    })

    const data = await response.json()

    messages.value.push({
      role: 'assistant',
      content: data.content,
      timestamp: Date.now(),
    })

    // Refresh sessions list to show updated titles
    if (props.showSidebar) {
      await loadSessions()
    }
  } catch (error) {
    console.error('Failed to send message:', error)
    messages.value.push({
      role: 'assistant',
      content: trans('laravilt-ai::ai.chat.error'),
      timestamp: Date.now(),
    })
  } finally {
    loading.value = false
    await nextTick()
    scrollToBottom()
    inputRef.value?.focus()
  }
}

// Stream message
async function streamMessage() {
  if (!canSend.value) return

  const userMessage: Message = {
    role: 'user',
    content: input.value.trim(),
    timestamp: Date.now(),
  }

  messages.value.push(userMessage)
  input.value = ''
  loading.value = true
  streaming.value = true

  if (inputRef.value) {
    inputRef.value.style.height = 'auto'
  }

  await nextTick()
  scrollToBottom()

  const assistantMessage: Message = {
    role: 'assistant',
    content: '',
    timestamp: Date.now(),
  }
  messages.value.push(assistantMessage)

  try {
    const response = await fetch(`${props.endpoint}/stream`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'text/event-stream',
        'X-CSRF-TOKEN': csrfToken.value,
      },
      credentials: 'same-origin',
      body: JSON.stringify({
        messages: messages.value
          .slice(0, -1)
          .map((m) => ({ role: m.role, content: m.content })),
        provider: selectedProvider.value,
        model: selectedModel.value,
      }),
    })

    const reader = response.body?.getReader()
    const decoder = new TextDecoder()

    if (reader) {
      while (true) {
        const { done, value } = await reader.read()
        if (done) break

        const chunk = decoder.decode(value)
        const lines = chunk.split('\n')

        for (const line of lines) {
          if (line.startsWith('data: ')) {
            const data = line.slice(6)
            if (data === '[DONE]') break

            try {
              const json = JSON.parse(data)
              if (json.content) {
                assistantMessage.content += json.content
                await nextTick()
                scrollToBottom()
              }
            } catch {
              // Ignore parsing errors
            }
          }
        }
      }
    }
  } catch (error) {
    console.error('Stream error:', error)
    assistantMessage.content = trans('laravilt-ai::ai.chat.error')
  } finally {
    loading.value = false
    streaming.value = false
    await nextTick()
    scrollToBottom()
    inputRef.value?.focus()
  }
}

function scrollToBottom() {
  if (chatContainerRef.value) {
    chatContainerRef.value.scrollTop = chatContainerRef.value.scrollHeight
  }
}

function handleKeydown(event: KeyboardEvent) {
  if (event.key === 'Enter' && !event.shiftKey) {
    event.preventDefault()
    sendMessage()
  }
}

async function copyMessage(content: string, index: number) {
  try {
    await navigator.clipboard.writeText(content)
    copiedMessageIndex.value = index
    setTimeout(() => {
      copiedMessageIndex.value = null
    }, 2000)
  } catch (error) {
    console.error('Failed to copy:', error)
  }
}

// Auto-resize textarea
function autoResize(event: Event) {
  const textarea = event.target as HTMLTextAreaElement
  textarea.style.height = 'auto'
  textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px'
}

function formatTime(timestamp: number | undefined): string {
  if (!timestamp) return ''
  return new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
}

onMounted(async () => {
  await loadConfig()
  if (props.showSidebar) {
    await loadSessions()
  }
})

watch(selectedProvider, (newProvider) => {
  if (config.value && newProvider) {
    const provider = config.value.providers[newProvider]
    if (provider) {
      selectedModel.value = provider.defaultModel
    }
  }
})
</script>

<template>
  <div class="flex h-full bg-background">
    <!-- Sidebar -->
    <aside
      v-if="showSidebar"
      :class="[
        'flex flex-col border-e border-border bg-sidebar transition-all duration-300',
        sidebarOpen ? 'w-72' : 'w-0 overflow-hidden'
      ]"
    >
      <!-- Sidebar Header -->
      <div class="flex h-14 items-center justify-between border-b border-sidebar-border bg-sidebar px-4">
        <Button
          variant="outline"
          size="sm"
          class="gap-2 border-sidebar-border bg-sidebar-accent text-sidebar-foreground hover:bg-sidebar-accent/80"
          @click="createSession"
        >
          <Plus class="h-4 w-4" />
          <span>{{ trans('laravilt-ai::ai.chat.new_chat') }}</span>
        </Button>
      </div>

      <!-- Sessions List -->
      <ScrollArea class="flex-1 px-3 py-3">
        <div class="space-y-1">
          <button
            v-for="session in sessions"
            :key="session.id"
            :class="[
              'group flex w-full items-center gap-3 rounded-md px-3 py-2 text-sm font-medium transition-colors',
              currentSession?.id === session.id
                ? 'bg-sidebar-accent text-sidebar-accent-foreground'
                : 'text-sidebar-foreground/70 hover:bg-sidebar-accent/50 hover:text-sidebar-foreground'
            ]"
            @click="loadSession(session)"
          >
            <MessageSquare class="h-4 w-4 shrink-0" />
            <span class="flex-1 truncate text-start">{{ session.title }}</span>
            <DropdownMenu>
              <DropdownMenuTrigger as-child>
                <Button
                  variant="ghost"
                  size="icon"
                  class="h-6 w-6 shrink-0 opacity-0 transition-opacity group-hover:opacity-100"
                  @click.stop
                >
                  <MoreHorizontal class="h-4 w-4" />
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent align="end">
                <DropdownMenuItem @click.stop="deleteSession(session.id)" class="text-destructive focus:text-destructive">
                  <Trash2 class="me-2 h-4 w-4" />
                  {{ trans('laravilt-ai::ai.chat.delete_session') }}
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          </button>
        </div>
      </ScrollArea>
    </aside>

    <!-- Main Chat Area -->
    <div class="flex flex-1 flex-col bg-background">
      <!-- Header -->
      <header class="flex h-14 items-center justify-between border-b border-border bg-card px-4 shadow-sm">
        <div class="flex items-center gap-3">
          <Button
            v-if="showSidebar"
            variant="ghost"
            size="icon"
            class="text-muted-foreground hover:text-foreground"
            @click="sidebarOpen = !sidebarOpen"
          >
            <PanelLeftClose v-if="sidebarOpen" class="h-5 w-5" />
            <PanelLeft v-else class="h-5 w-5" />
          </Button>
          <div class="flex items-center gap-2.5">
            <div class="flex h-9 w-9 items-center justify-center rounded-lg bg-gradient-to-br from-primary to-primary/70 shadow-sm">
              <Sparkles class="h-5 w-5 text-primary-foreground" />
            </div>
            <span class="text-base font-semibold text-foreground">{{ trans('laravilt-ai::ai.chat.title') }}</span>
          </div>
        </div>

        <!-- Model Selector -->
        <div class="flex items-center gap-2">
          <Select v-model="selectedProvider">
            <SelectTrigger class="h-9 w-[140px] border-input bg-background text-sm shadow-sm">
              <SelectValue :placeholder="trans('laravilt-ai::ai.providers.select_provider')">
                {{ currentProviderLabel }}
              </SelectValue>
            </SelectTrigger>
            <SelectContent>
              <SelectItem
                v-for="provider in availableProviders"
                :key="provider.key"
                :value="provider.key"
              >
                {{ provider.label }}
              </SelectItem>
            </SelectContent>
          </Select>

          <Select v-model="selectedModel">
            <SelectTrigger class="h-9 w-[180px] border-input bg-background text-sm shadow-sm">
              <SelectValue :placeholder="trans('laravilt-ai::ai.providers.select_model')">
                {{ currentModelLabel }}
              </SelectValue>
            </SelectTrigger>
            <SelectContent>
              <SelectItem
                v-for="model in availableModels"
                :key="model.key"
                :value="model.key"
              >
                {{ model.label }}
              </SelectItem>
            </SelectContent>
          </Select>
        </div>
      </header>

      <!-- Messages Area -->
      <div ref="chatContainerRef" class="flex-1 overflow-y-auto bg-muted/20">
        <!-- Loading Config -->
        <div
          v-if="configLoading"
          class="flex h-full items-center justify-center"
        >
          <div class="flex flex-col items-center gap-3">
            <Loader2 class="h-8 w-8 animate-spin text-primary" />
            <span class="text-sm text-muted-foreground">Loading AI configuration...</span>
          </div>
        </div>

        <!-- Not Configured -->
        <div
          v-else-if="!config?.configured"
          class="flex h-full flex-col items-center justify-center gap-4 p-8 text-center"
        >
          <div class="rounded-full bg-muted p-5 shadow-sm">
            <Settings2 class="h-10 w-10 text-muted-foreground" />
          </div>
          <div>
            <h3 class="text-lg font-semibold text-foreground">{{ trans('laravilt-ai::ai.errors.not_configured') }}</h3>
            <p class="mt-2 max-w-sm text-sm text-muted-foreground">
              Please configure AI providers in your panel settings to enable the AI assistant.
            </p>
          </div>
        </div>

        <!-- Empty State -->
        <div
          v-else-if="messages.length === 0"
          class="flex h-full flex-col items-center justify-center gap-8 p-8"
        >
          <div class="flex h-20 w-20 items-center justify-center rounded-2xl bg-gradient-to-br from-primary to-primary/60 shadow-lg">
            <Sparkles class="h-10 w-10 text-primary-foreground" />
          </div>
          <div class="text-center">
            <h2 class="text-2xl font-bold text-foreground">{{ trans('laravilt-ai::ai.chat.title') }}</h2>
            <p class="mt-3 max-w-lg text-muted-foreground">
              {{ trans('laravilt-ai::ai.chat.type_message') }}
            </p>
          </div>
          <div class="flex flex-wrap items-center justify-center gap-2">
            <Button variant="outline" size="sm" class="gap-2 text-xs" @click="input = 'Help me understand this codebase'">
              <Sparkles class="h-3 w-3" />
              Understand codebase
            </Button>
            <Button variant="outline" size="sm" class="gap-2 text-xs" @click="input = 'Generate a summary report'">
              <Sparkles class="h-3 w-3" />
              Generate report
            </Button>
            <Button variant="outline" size="sm" class="gap-2 text-xs" @click="input = 'Help me debug an issue'">
              <Sparkles class="h-3 w-3" />
              Debug issue
            </Button>
          </div>
        </div>

        <!-- Messages -->
        <div v-else class="mx-auto max-w-3xl space-y-6 px-4 py-6">
          <div
            v-for="(message, index) in messages"
            :key="index"
            :class="[
              'group flex gap-3',
              message.role === 'user' ? 'justify-end' : 'justify-start'
            ]"
          >
            <!-- Assistant Avatar -->
            <div
              v-if="message.role === 'assistant'"
              class="flex h-9 w-9 shrink-0 items-center justify-center rounded-lg bg-gradient-to-br from-primary to-primary/70 shadow-sm"
            >
              <Bot class="h-5 w-5 text-primary-foreground" />
            </div>

            <!-- Message Content -->
            <div
              :class="[
                'relative max-w-[80%] rounded-xl px-4 py-3 shadow-sm',
                message.role === 'user'
                  ? 'bg-primary text-primary-foreground'
                  : 'bg-card border border-border'
              ]"
            >
              <div class="whitespace-pre-wrap text-sm leading-relaxed">{{ message.content }}</div>
              <div
                :class="[
                  'mt-2 flex items-center justify-between gap-3 text-xs',
                  message.role === 'user' ? 'text-primary-foreground/60' : 'text-muted-foreground'
                ]"
              >
                <span>{{ formatTime(message.timestamp) }}</span>
                <!-- Copy Button inline -->
                <button
                  :class="[
                    'flex h-6 w-6 items-center justify-center rounded-md opacity-0 transition-all group-hover:opacity-100',
                    message.role === 'user' ? 'hover:bg-primary-foreground/10' : 'hover:bg-muted'
                  ]"
                  @click="copyMessage(message.content, index)"
                >
                  <Check v-if="copiedMessageIndex === index" class="h-3.5 w-3.5 text-green-500" />
                  <Copy v-else class="h-3.5 w-3.5" />
                </button>
              </div>
            </div>

            <!-- User Avatar -->
            <div
              v-if="message.role === 'user'"
              class="flex h-9 w-9 shrink-0 items-center justify-center rounded-lg bg-muted shadow-sm"
            >
              <User class="h-5 w-5 text-muted-foreground" />
            </div>
          </div>

          <!-- Typing Indicator -->
          <div v-if="loading && !streaming" class="flex gap-3">
            <div class="flex h-9 w-9 shrink-0 items-center justify-center rounded-lg bg-gradient-to-br from-primary to-primary/70 shadow-sm">
              <Bot class="h-5 w-5 text-primary-foreground" />
            </div>
            <div class="rounded-xl border border-border bg-card px-4 py-3 shadow-sm">
              <div class="flex items-center gap-1.5">
                <span class="h-2 w-2 animate-bounce rounded-full bg-primary/60" style="animation-delay: 0ms"></span>
                <span class="h-2 w-2 animate-bounce rounded-full bg-primary/60" style="animation-delay: 150ms"></span>
                <span class="h-2 w-2 animate-bounce rounded-full bg-primary/60" style="animation-delay: 300ms"></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Input Area -->
      <div class="border-t border-border bg-card p-4 shadow-[0_-1px_5px_rgba(0,0,0,0.03)]">
        <div class="mx-auto max-w-3xl">
          <div class="relative flex items-end gap-3 rounded-xl border border-input bg-background p-2 shadow-sm transition-shadow focus-within:shadow-md focus-within:ring-2 focus-within:ring-ring/50">
            <Textarea
              ref="inputRef"
              v-model="input"
              rows="1"
              class="min-h-[44px] flex-1 resize-none border-0 bg-transparent px-3 py-2.5 text-sm placeholder:text-muted-foreground focus-visible:ring-0"
              :placeholder="trans('laravilt-ai::ai.chat.type_message')"
              :disabled="loading || !config?.configured"
              @keydown="handleKeydown"
              @input="autoResize"
            />
            <Button
              size="icon"
              class="h-10 w-10 shrink-0 rounded-lg shadow-sm transition-transform hover:scale-105"
              :disabled="!canSend"
              @click="sendMessage"
            >
              <Loader2 v-if="loading" class="h-5 w-5 animate-spin" />
              <Send v-else class="h-5 w-5" />
            </Button>
          </div>
          <p class="mt-3 text-center text-xs text-muted-foreground">
            Press <kbd class="rounded bg-muted px-1.5 py-0.5 font-mono text-[10px]">Enter</kbd> to send • <kbd class="rounded bg-muted px-1.5 py-0.5 font-mono text-[10px]">Shift+Enter</kbd> for new line
          </p>
        </div>
      </div>
    </div>
  </div>
</template>
</file>

<file path="resources/js/components/GlobalSearch.vue">
<script setup lang="ts">
import { ref, computed, watch, onMounted, onUnmounted } from 'vue'
import { Search, Loader2, X, Sparkles, ArrowRight, Command, FileText, Users, Package, Settings, Database } from 'lucide-vue-next'
import { usePage } from '@inertiajs/vue3'
import * as LucideIcons from 'lucide-vue-next'
import { useLocalization } from '@/composables/useLocalization'

interface SearchResult {
  id: string | number
  title: string
  subtitle?: string
  url: string
}

interface SearchGroup {
  resource: string
  label: string
  icon?: string
  url: string
  results: SearchResult[]
}

const props = withDefaults(
  defineProps<{
    placeholder?: string
  }>(),
  {
    placeholder: undefined,
  }
)

const emit = defineEmits<{
  (e: 'select', result: SearchResult, group: SearchGroup): void
  (e: 'close'): void
}>()

const { trans } = useLocalization()

const page = usePage<{
  panel?: {
    hasGlobalSearch?: boolean
    globalSearchEndpoint?: string
    globalSearchConfig?: {
      enabled?: boolean
      useAI?: boolean
      debounce?: number
    }
    hasAI?: boolean
  }
}>()

const isOpen = ref(false)
const query = ref('')
const loading = ref(false)
const results = ref<SearchGroup[]>([])
const selectedIndex = ref(0)
const inputRef = ref<HTMLInputElement | null>(null)
const useAI = ref(false)

// Initialize AI mode from config
onMounted(() => {
  useAI.value = page.props.panel?.globalSearchConfig?.useAI ?? false
})

const hasGlobalSearch = computed(() => page.props.panel?.hasGlobalSearch ?? true)
const hasAIConfig = computed(() => page.props.panel?.hasAI ?? false)
const endpoint = computed(() => page.props.panel?.globalSearchEndpoint ?? '/global-search')
const debounceMs = computed(() => page.props.panel?.globalSearchConfig?.debounce ?? 300)

// Translation helper with proper keys from laravilt-ai::ai.search.*
const t = computed(() => ({
  placeholder: props.placeholder ?? trans('laravilt-ai::ai.search.placeholder'),
  ai_powered: trans('laravilt-ai::ai.search.ai_powered'),
  no_results: trans('laravilt-ai::ai.search.no_results'),
  no_results_for: trans('laravilt-ai::ai.search.no_results_for'),
  try_different: trans('laravilt-ai::ai.search.try_different'),
  start_typing: trans('laravilt-ai::ai.search.start_typing'),
  results_count: trans('laravilt-ai::ai.search.results_count'),
  type_to_search: trans('laravilt-ai::ai.search.type_to_search'),
  to_navigate: trans('laravilt-ai::ai.search.to_navigate'),
  to_select: trans('laravilt-ai::ai.search.to_select'),
  to_close: trans('laravilt-ai::ai.search.to_close'),
  toggle_ai: trans('laravilt-ai::ai.search.toggle_ai'),
  ai_enabled: trans('laravilt-ai::ai.search.ai_enabled'),
  ai_disabled: trans('laravilt-ai::ai.search.ai_disabled'),
}))

// Flatten results for keyboard navigation
const flatResults = computed(() => {
  const flat: { result: SearchResult; group: SearchGroup; index: number }[] = []
  let index = 0
  for (const group of results.value) {
    for (const result of group.results) {
      flat.push({ result, group, index })
      index++
    }
  }
  return flat
})

const totalResults = computed(() => flatResults.value.length)

// Search debounce
let searchTimeout: ReturnType<typeof setTimeout> | null = null

watch(query, (newQuery) => {
  if (searchTimeout) {
    clearTimeout(searchTimeout)
  }

  if (!newQuery.trim()) {
    results.value = []
    return
  }

  searchTimeout = setTimeout(async () => {
    await performSearch(newQuery)
  }, debounceMs.value)
})

async function performSearch(searchQuery: string) {
  loading.value = true
  selectedIndex.value = 0

  try {
    const response = await fetch(
      `${endpoint.value}?query=${encodeURIComponent(searchQuery)}&useAI=${useAI.value}`
    )
    const data = await response.json()
    results.value = data.results || []
  } catch (error) {
    console.error('Search error:', error)
    results.value = []
  } finally {
    loading.value = false
  }
}

function toggleAI() {
  useAI.value = !useAI.value
  // Re-search if there's a query
  if (query.value.trim()) {
    performSearch(query.value)
  }
}

function open() {
  isOpen.value = true
  setTimeout(() => {
    inputRef.value?.focus()
  }, 100)
}

function close() {
  isOpen.value = false
  query.value = ''
  results.value = []
  selectedIndex.value = 0
  emit('close')
}

function selectResult(result: SearchResult, group: SearchGroup) {
  emit('select', result, group)
  if (result.url) {
    window.location.href = result.url
  }
  close()
}

function handleKeydown(event: KeyboardEvent) {
  if (!isOpen.value) return

  switch (event.key) {
    case 'ArrowDown':
      event.preventDefault()
      selectedIndex.value = Math.min(selectedIndex.value + 1, totalResults.value - 1)
      break
    case 'ArrowUp':
      event.preventDefault()
      selectedIndex.value = Math.max(selectedIndex.value - 1, 0)
      break
    case 'Enter':
      event.preventDefault()
      const selected = flatResults.value[selectedIndex.value]
      if (selected) {
        selectResult(selected.result, selected.group)
      }
      break
    case 'Escape':
      event.preventDefault()
      close()
      break
  }
}

// Global keyboard shortcut (Cmd/Ctrl + K) and ESC
function handleGlobalKeydown(event: KeyboardEvent) {
  // Handle Cmd/Ctrl + K
  if ((event.metaKey || event.ctrlKey) && event.key === 'k') {
    event.preventDefault()
    if (isOpen.value) {
      close()
    } else {
      open()
    }
    return
  }

  // Handle ESC globally (even when input is not focused)
  if (event.key === 'Escape' && isOpen.value) {
    event.preventDefault()
    event.stopPropagation()
    close()
  }
}

onMounted(() => {
  document.addEventListener('keydown', handleGlobalKeydown, true)
})

onUnmounted(() => {
  document.removeEventListener('keydown', handleGlobalKeydown, true)
})

// Map of resource icons with fallback
const resourceIconMap: Record<string, string> = {
  'users': 'Users',
  'products': 'Package',
  'settings': 'Settings',
  'documents': 'FileText',
  'files': 'FileText',
}

// Get icon component for a group
function getIconComponent(iconName?: string): any {
  if (!iconName) return Database

  // Try direct name first
  if ((LucideIcons as any)[iconName]) {
    return (LucideIcons as any)[iconName]
  }

  // Convert kebab-case to PascalCase
  const pascalCase = iconName
    .split('-')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join('')

  if ((LucideIcons as any)[pascalCase]) {
    return (LucideIcons as any)[pascalCase]
  }

  // Try without heroicon prefix
  const withoutPrefix = iconName.replace(/^heroicon-[os]-/, '')
  const cleanPascal = withoutPrefix
    .split('-')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join('')

  if ((LucideIcons as any)[cleanPascal]) {
    return (LucideIcons as any)[cleanPascal]
  }

  return Database
}

// Get icon color class for a group (for variety)
function getIconColorClass(index: number): string {
  const colors = [
    'bg-blue-500/10 text-blue-500 dark:bg-blue-500/20 dark:text-blue-400',
    'bg-purple-500/10 text-purple-500 dark:bg-purple-500/20 dark:text-purple-400',
    'bg-green-500/10 text-green-500 dark:bg-green-500/20 dark:text-green-400',
    'bg-orange-500/10 text-orange-500 dark:bg-orange-500/20 dark:text-orange-400',
    'bg-pink-500/10 text-pink-500 dark:bg-pink-500/20 dark:text-pink-400',
    'bg-cyan-500/10 text-cyan-500 dark:bg-cyan-500/20 dark:text-cyan-400',
  ]
  return colors[index % colors.length]
}

defineExpose({ open, close })
</script>

<template>
  <!-- Trigger Button - shadcn style -->
  <button
    v-if="hasGlobalSearch"
    type="button"
    class="inline-flex items-center justify-center gap-2 rounded-lg border border-input bg-background px-3 py-1.5 text-sm text-muted-foreground shadow-sm transition hover:bg-accent hover:text-accent-foreground"
    :title="t.placeholder"
    @click="open"
  >
    <Search class="h-4 w-4" />
    <kbd
      class="pointer-events-none hidden h-5 select-none items-center gap-0.5 rounded border border-input bg-muted px-1.5 font-mono text-[10px] font-medium sm:flex"
    >
      <Command class="h-2.5 w-2.5" />K
    </kbd>
  </button>

  <!-- Spotlight Modal - shadcn style -->
  <Teleport to="body">
    <Transition
      enter-active-class="duration-200 ease-out"
      enter-from-class="opacity-0"
      enter-to-class="opacity-100"
      leave-active-class="duration-150 ease-in"
      leave-from-class="opacity-100"
      leave-to-class="opacity-0"
    >
      <div
        v-if="isOpen"
        class="fixed inset-0 z-50 overflow-y-auto p-4 pt-[15vh] sm:p-6 sm:pt-[20vh]"
        @click.self="close"
      >
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-black/50 backdrop-blur-sm transition-opacity" />

        <!-- Modal -->
        <Transition
          enter-active-class="duration-200 ease-out"
          enter-from-class="opacity-0 scale-95 translate-y-4"
          enter-to-class="opacity-100 scale-100 translate-y-0"
          leave-active-class="duration-150 ease-in"
          leave-from-class="opacity-100 scale-100 translate-y-0"
          leave-to-class="opacity-0 scale-95 translate-y-4"
        >
          <div
            v-if="isOpen"
            class="relative mx-auto max-w-2xl transform overflow-hidden rounded-xl bg-popover text-popover-foreground shadow-2xl ring-1 ring-border transition-all"
          >
            <!-- Search Input - shadcn style -->
            <div class="relative flex items-center px-4 py-3">
              <div class="flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-lg bg-muted">
                <Search class="h-5 w-5 text-muted-foreground" />
              </div>
              <input
                ref="inputRef"
                v-model="query"
                type="text"
                class="h-12 flex-1 border-0 bg-transparent px-4 text-lg text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-0"
                :placeholder="t.placeholder"
                @keydown="handleKeydown"
              />
              <div class="flex items-center gap-2">
                <!-- AI Toggle Button -->
                <button
                  v-if="hasAIConfig"
                  type="button"
                  class="flex h-9 w-9 items-center justify-center rounded-lg transition-all duration-200"
                  :class="[
                    useAI
                      ? 'bg-primary text-primary-foreground shadow-sm'
                      : 'bg-muted text-muted-foreground hover:bg-accent hover:text-accent-foreground',
                  ]"
                  :title="useAI ? t.ai_enabled : t.ai_disabled"
                  @click="toggleAI"
                >
                  <Sparkles class="h-4 w-4" />
                </button>
                <Loader2 v-if="loading" class="h-5 w-5 animate-spin text-muted-foreground" />
                <button
                  v-else-if="query"
                  type="button"
                  class="flex h-8 w-8 items-center justify-center rounded-lg bg-muted text-muted-foreground transition hover:bg-accent hover:text-accent-foreground"
                  @click="query = ''"
                >
                  <X class="h-4 w-4" />
                </button>
              </div>
            </div>

            <!-- AI Badge -->
            <div
              v-if="useAI && hasAIConfig"
              class="mx-4 mb-3 inline-flex items-center gap-1.5 rounded-full bg-primary/10 px-3 py-1 text-xs font-medium text-primary"
            >
              <Sparkles class="h-3 w-3" />
              <span>{{ t.ai_powered }}</span>
            </div>

            <!-- Divider -->
            <div v-if="results.length > 0 || query" class="mx-4 h-px bg-border" />

            <!-- Results - shadcn style -->
            <div v-if="results.length > 0" class="max-h-[50vh] overflow-y-auto overscroll-contain px-3 py-3">
              <div v-for="(group, groupIndex) in results" :key="group.resource" class="mb-4 last:mb-0">
                <!-- Group Header -->
                <h3
                  class="mb-2 flex items-center gap-2 px-2 text-xs font-semibold uppercase tracking-wider text-muted-foreground"
                >
                  <component :is="getIconComponent(group.icon)" class="h-3.5 w-3.5" />
                  {{ group.label }}
                </h3>

                <!-- Results List -->
                <ul class="space-y-1">
                  <li v-for="(result, idx) in group.results" :key="result.id">
                    <button
                      type="button"
                      class="group flex w-full items-center gap-3 rounded-lg px-3 py-2.5 text-left transition-all duration-150"
                      :class="[
                        flatResults.findIndex((f) => f.result === result) === selectedIndex
                          ? 'bg-primary text-primary-foreground'
                          : 'text-foreground hover:bg-accent',
                      ]"
                      @click="selectResult(result, group)"
                      @mouseenter="selectedIndex = flatResults.findIndex((f) => f.result === result)"
                    >
                      <!-- Icon with color background -->
                      <div
                        class="flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-lg transition-colors"
                        :class="[
                          flatResults.findIndex((f) => f.result === result) === selectedIndex
                            ? 'bg-primary-foreground/20'
                            : 'bg-muted',
                        ]"
                      >
                        <component
                          :is="getIconComponent(group.icon)"
                          class="h-5 w-5"
                          :class="[
                            flatResults.findIndex((f) => f.result === result) === selectedIndex
                              ? 'text-primary-foreground'
                              : 'text-muted-foreground',
                          ]"
                        />
                      </div>

                      <!-- Content -->
                      <div class="flex-1 min-w-0">
                        <div class="truncate font-medium">{{ result.title }}</div>
                        <div
                          v-if="result.subtitle"
                          class="truncate text-sm"
                          :class="[
                            flatResults.findIndex((f) => f.result === result) === selectedIndex
                              ? 'text-primary-foreground/70'
                              : 'text-muted-foreground',
                          ]"
                        >
                          {{ result.subtitle }}
                        </div>
                      </div>

                      <!-- Arrow indicator -->
                      <div
                        class="flex h-8 w-8 flex-shrink-0 items-center justify-center rounded-md transition-all"
                        :class="[
                          flatResults.findIndex((f) => f.result === result) === selectedIndex
                            ? 'bg-primary-foreground/20 text-primary-foreground'
                            : 'bg-muted text-muted-foreground opacity-0 group-hover:opacity-100',
                        ]"
                      >
                        <ArrowRight class="h-4 w-4" />
                      </div>
                    </button>
                  </li>
                </ul>
              </div>
            </div>

            <!-- Empty State - shadcn style -->
            <div
              v-else-if="query && !loading"
              class="px-6 py-14 text-center"
            >
              <div class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-xl bg-muted">
                <Search class="h-8 w-8 text-muted-foreground/50" />
              </div>
              <p class="text-lg font-medium text-foreground">{{ t.no_results }}</p>
              <p class="mt-1 text-sm text-muted-foreground">
                {{ trans('laravilt-ai::ai.search.no_results_for', { query }) }}
              </p>
            </div>

            <!-- Initial State - shadcn style -->
            <div
              v-else-if="!query"
              class="px-6 py-14 text-center"
            >
              <div class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-xl bg-muted">
                <Search class="h-8 w-8 text-muted-foreground/50" />
              </div>
              <p class="text-lg font-medium text-foreground">{{ t.start_typing }}</p>
              <p class="mt-1 text-sm text-muted-foreground">{{ t.type_to_search }}</p>
            </div>

            <!-- Footer - shadcn style -->
            <div
              class="flex items-center justify-between border-t border-border bg-muted/50 px-4 py-2.5"
            >
              <span class="text-xs text-muted-foreground">
                <template v-if="totalResults > 0">{{ trans('laravilt-ai::ai.search.results_count', { count: totalResults }) }}</template>
                <template v-else>{{ t.type_to_search }}</template>
              </span>
              <div class="flex items-center gap-3 text-xs text-muted-foreground">
                <div class="flex items-center gap-1">
                  <kbd class="flex h-5 items-center justify-center rounded border border-input bg-background px-1.5 font-mono text-[10px] font-medium">↑</kbd>
                  <kbd class="flex h-5 items-center justify-center rounded border border-input bg-background px-1.5 font-mono text-[10px] font-medium">↓</kbd>
                  <span class="ms-1">{{ t.to_navigate }}</span>
                </div>
                <div class="flex items-center gap-1">
                  <kbd class="flex h-5 items-center justify-center rounded border border-input bg-background px-1.5 font-mono text-[10px] font-medium">↵</kbd>
                  <span class="ms-1">{{ t.to_select }}</span>
                </div>
                <div class="flex items-center gap-1">
                  <kbd class="flex h-5 items-center justify-center rounded border border-input bg-background px-2 font-mono text-[10px] font-medium">esc</kbd>
                  <span class="ms-1">{{ t.to_close }}</span>
                </div>
              </div>
            </div>
          </div>
        </Transition>
      </div>
    </Transition>
  </Teleport>
</template>
</file>

<file path="resources/js/composables/useAI.ts">
import { ref, computed } from 'vue'

interface Message {
  role: 'system' | 'user' | 'assistant'
  content: string
  timestamp?: number
}

interface Provider {
  name: string
  label: string
  models: Record<string, string>
  defaultModel: string
  configured: boolean
}

interface AIConfig {
  configured: boolean
  default: string
  providers: Record<string, Provider>
}

const config = ref<AIConfig | null>(null)
const loading = ref(false)
const error = ref<string | null>(null)

export function useAI(endpoint = '/laravilt-ai') {
  const selectedProvider = ref<string>('')
  const selectedModel = ref<string>('')

  const isConfigured = computed(() => config.value?.configured ?? false)

  const availableProviders = computed(() => {
    if (!config.value) return []
    return Object.entries(config.value.providers)
      .filter(([, p]) => p.configured)
      .map(([key, p]) => ({ key, ...p }))
  })

  const availableModels = computed(() => {
    if (!config.value || !selectedProvider.value) return []
    const provider = config.value.providers[selectedProvider.value]
    if (!provider) return []
    return Object.entries(provider.models).map(([key, label]) => ({ key, label }))
  })

  async function loadConfig() {
    if (config.value) return config.value

    loading.value = true
    error.value = null

    try {
      const response = await fetch(`${endpoint}/config`)
      config.value = await response.json()

      if (config.value?.default) {
        selectedProvider.value = config.value.default
        const provider = config.value.providers[config.value.default]
        if (provider) {
          selectedModel.value = provider.defaultModel
        }
      }

      return config.value
    } catch (e) {
      error.value = e instanceof Error ? e.message : 'Failed to load AI config'
      throw e
    } finally {
      loading.value = false
    }
  }

  async function chat(messages: Message[], options: { provider?: string; model?: string } = {}) {
    loading.value = true
    error.value = null

    try {
      const response = await fetch(`${endpoint}/chat`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          messages: messages.map((m) => ({ role: m.role, content: m.content })),
          provider: options.provider || selectedProvider.value,
          model: options.model || selectedModel.value,
        }),
      })

      return await response.json()
    } catch (e) {
      error.value = e instanceof Error ? e.message : 'Failed to send message'
      throw e
    } finally {
      loading.value = false
    }
  }

  async function* streamChat(
    messages: Message[],
    options: { provider?: string; model?: string } = {}
  ): AsyncGenerator<string> {
    loading.value = true
    error.value = null

    try {
      const response = await fetch(`${endpoint}/stream`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          messages: messages.map((m) => ({ role: m.role, content: m.content })),
          provider: options.provider || selectedProvider.value,
          model: options.model || selectedModel.value,
        }),
      })

      const reader = response.body?.getReader()
      const decoder = new TextDecoder()

      if (reader) {
        while (true) {
          const { done, value } = await reader.read()
          if (done) break

          const chunk = decoder.decode(value)
          const lines = chunk.split('\n')

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = line.slice(6)
              if (data === '[DONE]') break

              try {
                const json = JSON.parse(data)
                if (json.content) {
                  yield json.content
                }
              } catch {
                // Ignore parsing errors
              }
            }
          }
        }
      }
    } catch (e) {
      error.value = e instanceof Error ? e.message : 'Stream error'
      throw e
    } finally {
      loading.value = false
    }
  }

  return {
    config,
    loading,
    error,
    selectedProvider,
    selectedModel,
    isConfigured,
    availableProviders,
    availableModels,
    loadConfig,
    chat,
    streamChat,
  }
}
</file>

<file path="resources/js/composables/useGlobalSearch.ts">
import { ref, computed } from 'vue'

interface SearchResult {
  id: string | number
  title: string
  subtitle?: string
  url: string
}

interface SearchGroup {
  resource: string
  label: string
  icon?: string
  url: string
  results: SearchResult[]
}

export function useGlobalSearch(endpoint = '/laravilt-ai/search') {
  const query = ref('')
  const results = ref<SearchGroup[]>([])
  const loading = ref(false)
  const error = ref<string | null>(null)
  const useAI = ref(true)

  let searchTimeout: ReturnType<typeof setTimeout> | null = null

  const hasResults = computed(() => results.value.length > 0)

  const totalResults = computed(() => {
    return results.value.reduce((total, group) => total + group.results.length, 0)
  })

  async function search(searchQuery: string) {
    if (!searchQuery.trim()) {
      results.value = []
      return []
    }

    loading.value = true
    error.value = null

    try {
      const response = await fetch(
        `${endpoint}?query=${encodeURIComponent(searchQuery)}&useAI=${useAI.value}`
      )
      const data = await response.json()
      results.value = data.results || []
      return results.value
    } catch (e) {
      error.value = e instanceof Error ? e.message : 'Search failed'
      results.value = []
      throw e
    } finally {
      loading.value = false
    }
  }

  function debouncedSearch(searchQuery: string, delay = 300) {
    if (searchTimeout) {
      clearTimeout(searchTimeout)
    }

    return new Promise<SearchGroup[]>((resolve, reject) => {
      searchTimeout = setTimeout(async () => {
        try {
          const result = await search(searchQuery)
          resolve(result)
        } catch (e) {
          reject(e)
        }
      }, delay)
    })
  }

  function clear() {
    query.value = ''
    results.value = []
    error.value = null
  }

  return {
    query,
    results,
    loading,
    error,
    useAI,
    hasResults,
    totalResults,
    search,
    debouncedSearch,
    clear,
  }
}
</file>

<file path="resources/js/app.js">
/**
 * Ai Plugin for Vue.js
 *
 * This plugin can be registered in your main Laravilt application.
 *
 * Example usage in app.ts:
 *
 * import AiPlugin from '@/plugins/ai';
 *
 * app.use(AiPlugin, {
 *     // Plugin options
 * });
 */

export default {
    install(app, options = {}) {
        // Plugin installation logic
        console.log('Ai plugin installed', options);

        // Register global components
        // app.component('AiComponent', ComponentName);

        // Provide global properties
        // app.config.globalProperties.$ai = {};

        // Add global methods
        // app.mixin({});
    }
};
</file>

<file path="resources/js/app.ts">
// Export Vue components
export { default as GlobalSearch } from './components/GlobalSearch.vue'
export { default as AIChat } from './components/AIChat.vue'

// Export composables
export * from './composables/useAI'
export * from './composables/useGlobalSearch'
</file>

<file path="resources/lang/ar/ai.php">
<?php

return [
    // Global Search
    'search' => [
        'placeholder' => 'بحث...',
        'ai_powered' => 'بحث مدعوم بالذكاء الاصطناعي',
        'no_results' => 'لا توجد نتائج',
        'no_results_for' => 'لا توجد نتائج لـ ":query"',
        'try_different' => 'حاول البحث بكلمات مختلفة',
        'start_typing' => 'ابدأ الكتابة للبحث',
        'results_count' => ':count نتائج',
        'type_to_search' => 'اكتب للبحث',
        'press_to_close' => 'اضغط :key للإغلاق',
        'to_navigate' => 'للتنقل',
        'to_select' => 'للاختيار',
        'to_close' => 'للإغلاق',
        'toggle_ai' => 'تبديل بحث الذكاء الاصطناعي',
        'ai_enabled' => 'بحث الذكاء الاصطناعي مفعل',
        'ai_disabled' => 'بحث الذكاء الاصطناعي معطل',
    ],

    // Chat
    'chat' => [
        'title' => 'محادثة الذكاء الاصطناعي',
        'new_chat' => 'محادثة جديدة',
        'send_message' => 'إرسال الرسالة',
        'type_message' => 'اكتب رسالتك...',
        'thinking' => 'جاري التفكير...',
        'error' => 'حدث خطأ. يرجى المحاولة مرة أخرى.',
        'sessions' => 'جلسات المحادثة',
        'no_sessions' => 'لا توجد جلسات محادثة',
        'delete_session' => 'حذف الجلسة',
        'delete_confirm' => 'هل أنت متأكد من حذف هذه الجلسة؟',
        'clear_chat' => 'مسح المحادثة',
        'clear_confirm' => 'هل أنت متأكد من مسح هذه المحادثة؟',
        'copy_message' => 'نسخ الرسالة',
        'copied' => 'تم النسخ',
        'regenerate' => 'إعادة توليد الرد',
    ],

    // Providers
    'providers' => [
        'openai' => 'OpenAI',
        'anthropic' => 'Anthropic (Claude)',
        'gemini' => 'Google Gemini',
        'deepseek' => 'DeepSeek',
        'select_provider' => 'اختر مزود الذكاء الاصطناعي',
        'select_model' => 'اختر النموذج',
    ],

    // Settings
    'settings' => [
        'title' => 'إعدادات الذكاء الاصطناعي',
        'provider' => 'مزود الذكاء الاصطناعي',
        'model' => 'النموذج',
        'temperature' => 'درجة الحرارة',
        'max_tokens' => 'الحد الأقصى للرموز',
    ],

    // Actions
    'actions' => [
        'ask_ai' => 'اسأل الذكاء الاصطناعي',
        'generate' => 'توليد',
        'generating' => 'جاري التوليد...',
        'improve' => 'تحسين بالذكاء الاصطناعي',
        'translate' => 'ترجمة',
        'summarize' => 'تلخيص',
        'explain' => 'شرح',
    ],

    // Errors
    'errors' => [
        'not_configured' => 'الذكاء الاصطناعي غير مُهيأ. يرجى إضافة مفتاح API الخاص بك.',
        'provider_error' => 'خطأ في الاتصال بمزود الذكاء الاصطناعي.',
        'rate_limit' => 'تم تجاوز حد المعدل. يرجى المحاولة لاحقاً.',
        'invalid_response' => 'استجابة غير صالحة من مزود الذكاء الاصطناعي.',
    ],
];
</file>

<file path="resources/lang/en/ai.php">
<?php

return [
    // Global Search
    'search' => [
        'placeholder' => 'Search...',
        'ai_powered' => 'AI-powered search',
        'no_results' => 'No results found',
        'no_results_for' => 'No results found for ":query"',
        'try_different' => 'Try searching with different keywords',
        'start_typing' => 'Start typing to search',
        'results_count' => ':count results',
        'type_to_search' => 'Type to search',
        'press_to_close' => 'Press :key to close',
        'to_navigate' => 'to navigate',
        'to_select' => 'to select',
        'to_close' => 'to close',
        'toggle_ai' => 'Toggle AI search',
        'ai_enabled' => 'AI search enabled',
        'ai_disabled' => 'AI search disabled',
    ],

    // Chat
    'chat' => [
        'title' => 'AI Chat',
        'new_chat' => 'New Chat',
        'send_message' => 'Send message',
        'type_message' => 'Type your message...',
        'thinking' => 'Thinking...',
        'error' => 'An error occurred. Please try again.',
        'sessions' => 'Chat Sessions',
        'no_sessions' => 'No chat sessions',
        'delete_session' => 'Delete session',
        'delete_confirm' => 'Are you sure you want to delete this session?',
        'clear_chat' => 'Clear chat',
        'clear_confirm' => 'Are you sure you want to clear this chat?',
        'copy_message' => 'Copy message',
        'copied' => 'Copied to clipboard',
        'regenerate' => 'Regenerate response',
    ],

    // Providers
    'providers' => [
        'openai' => 'OpenAI',
        'anthropic' => 'Anthropic (Claude)',
        'gemini' => 'Google Gemini',
        'deepseek' => 'DeepSeek',
        'select_provider' => 'Select AI Provider',
        'select_model' => 'Select Model',
    ],

    // Settings
    'settings' => [
        'title' => 'AI Settings',
        'provider' => 'AI Provider',
        'model' => 'Model',
        'temperature' => 'Temperature',
        'max_tokens' => 'Max Tokens',
    ],

    // Actions
    'actions' => [
        'ask_ai' => 'Ask AI',
        'generate' => 'Generate',
        'generating' => 'Generating...',
        'improve' => 'Improve with AI',
        'translate' => 'Translate',
        'summarize' => 'Summarize',
        'explain' => 'Explain',
    ],

    // Errors
    'errors' => [
        'not_configured' => 'AI is not configured. Please add your API key.',
        'provider_error' => 'Error communicating with AI provider.',
        'rate_limit' => 'Rate limit exceeded. Please try again later.',
        'invalid_response' => 'Invalid response from AI provider.',
    ],
];
</file>

<file path="routes/web.php">
<?php

use Illuminate\Support\Facades\Route;

/*
|--------------------------------------------------------------------------
| Ai Web Routes
|--------------------------------------------------------------------------
|
| Here is where you can register web routes for your plugin. These
| routes are loaded by the ServiceProvider within a group which
| contains the "web" middleware group.
|
*/

Route::middleware(['web'])->group(function () {
    // Add your web routes here
    // Example:
    // Route::get('/ai', function () {
    //     return view('ai::index');
    // });
});
</file>

<file path="src/Builders/AIProviderBuilder.php">
<?php

declare(strict_types=1);

namespace Laravilt\AI\Builders;

use Laravilt\AI\Contracts\AIProvider;

class AIProviderBuilder
{
    /**
     * @var array<AIProvider>
     */
    protected array $providers = [];

    /**
     * Default provider name.
     */
    protected ?string $defaultProvider = null;

    /**
     * Add an AI provider.
     *
     * @param  class-string<AIProvider>|AIProvider  $provider
     */
    public function provider(string|AIProvider $provider, ?callable $configure = null): static
    {
        if (is_string($provider)) {
            $instance = new $provider;
        } else {
            $instance = $provider;
        }

        if ($configure) {
            $configure($instance);
        }

        $this->providers[] = $instance;

        return $this;
    }

    /**
     * Add OpenAI provider.
     */
    public function openai(?callable $configure = null): static
    {
        return $this->provider(\Laravilt\AI\Providers\OpenAIProvider::class, $configure);
    }

    /**
     * Add Anthropic (Claude) provider.
     */
    public function anthropic(?callable $configure = null): static
    {
        return $this->provider(\Laravilt\AI\Providers\AnthropicProvider::class, $configure);
    }

    /**
     * Add Google Gemini provider.
     */
    public function gemini(?callable $configure = null): static
    {
        return $this->provider(\Laravilt\AI\Providers\GeminiProvider::class, $configure);
    }

    /**
     * Add DeepSeek provider.
     */
    public function deepseek(?callable $configure = null): static
    {
        return $this->provider(\Laravilt\AI\Providers\DeepSeekProvider::class, $configure);
    }

    /**
     * Add Perplexity provider.
     */
    public function perplexity(?callable $configure = null): static
    {
        return $this->provider(\Laravilt\AI\Providers\PerplexityProvider::class, $configure);
    }

    /**
     * Set the default provider.
     */
    public function default(string $providerName): static
    {
        $this->defaultProvider = $providerName;

        return $this;
    }

    /**
     * Get all registered providers.
     *
     * @return array<AIProvider>
     */
    public function getProviders(): array
    {
        return $this->providers;
    }

    /**
     * Get enabled/configured providers only.
     *
     * @return array<AIProvider>
     */
    public function getConfiguredProviders(): array
    {
        return array_values(array_filter(
            $this->providers,
            fn (AIProvider $provider) => $provider->isConfigured()
        ));
    }

    /**
     * Get provider by name.
     */
    public function getProvider(string $name): ?AIProvider
    {
        foreach ($this->providers as $provider) {
            if ($provider->getName() === $name) {
                return $provider;
            }
        }

        return null;
    }

    /**
     * Get the default provider.
     */
    public function getDefaultProvider(): ?AIProvider
    {
        if ($this->defaultProvider) {
            $provider = $this->getProvider($this->defaultProvider);
            if ($provider && $provider->isConfigured()) {
                return $provider;
            }
        }

        // Return first configured provider
        $configured = $this->getConfiguredProviders();

        return $configured[0] ?? null;
    }

    /**
     * Get default provider name.
     */
    public function getDefaultProviderName(): ?string
    {
        return $this->defaultProvider ?? $this->getDefaultProvider()?->getName();
    }

    /**
     * Get provider names.
     *
     * @return array<string>
     */
    public function getProviderNames(): array
    {
        return array_map(
            fn (AIProvider $provider) => $provider->getName(),
            $this->getConfiguredProviders()
        );
    }

    /**
     * Check if any provider is configured.
     */
    public function hasConfiguredProviders(): bool
    {
        return count($this->getConfiguredProviders()) > 0;
    }

    /**
     * Convert to array for frontend.
     *
     * @return array<string, mixed>
     */
    public function toArray(): array
    {
        return [
            'providers' => array_map(
                fn (AIProvider $provider) => $provider->toArray(),
                $this->getConfiguredProviders()
            ),
            'defaultProvider' => $this->getDefaultProviderName(),
        ];
    }
}
</file>

<file path="src/Builders/GlobalSearchBuilder.php">
<?php

declare(strict_types=1);

namespace Laravilt\AI\Builders;

use Closure;

class GlobalSearchBuilder
{
    /**
     * Is global search enabled.
     */
    protected bool $enabled = true;

    /**
     * Use AI for search query understanding.
     */
    protected bool $useAI = false;

    /**
     * Maximum results per resource.
     */
    protected int $limit = 5;

    /**
     * Maximum total results.
     */
    protected int $maxResults = 25;

    /**
     * Debounce delay in milliseconds.
     */
    protected int $debounce = 300;

    /**
     * Keyboard shortcut to open search.
     */
    protected string $shortcut = 'cmd+k';

    /**
     * Search endpoint URL.
     */
    protected ?string $endpoint = null;

    /**
     * Custom search handler.
     */
    protected ?Closure $searchHandler = null;

    /**
     * Resources to exclude from search.
     */
    protected array $excludedResources = [];

    /**
     * Enable global search.
     */
    public function enabled(bool $enabled = true): static
    {
        $this->enabled = $enabled;

        return $this;
    }

    /**
     * Disable global search.
     */
    public function disabled(): static
    {
        $this->enabled = false;

        return $this;
    }

    /**
     * Enable AI-powered search understanding.
     */
    public function withAI(bool $useAI = true): static
    {
        $this->useAI = $useAI;

        return $this;
    }

    /**
     * Disable AI-powered search.
     */
    public function withoutAI(): static
    {
        $this->useAI = false;

        return $this;
    }

    /**
     * Set maximum results per resource.
     */
    public function limit(int $limit): static
    {
        $this->limit = $limit;

        return $this;
    }

    /**
     * Set maximum total results.
     */
    public function maxResults(int $maxResults): static
    {
        $this->maxResults = $maxResults;

        return $this;
    }

    /**
     * Set debounce delay.
     */
    public function debounce(int $milliseconds): static
    {
        $this->debounce = $milliseconds;

        return $this;
    }

    /**
     * Set keyboard shortcut.
     */
    public function shortcut(string $shortcut): static
    {
        $this->shortcut = $shortcut;

        return $this;
    }

    /**
     * Set custom endpoint URL.
     */
    public function endpoint(string $endpoint): static
    {
        $this->endpoint = $endpoint;

        return $this;
    }

    /**
     * Set custom search handler.
     */
    public function using(Closure $handler): static
    {
        $this->searchHandler = $handler;

        return $this;
    }

    /**
     * Exclude resources from search.
     *
     * @param  array<class-string>  $resources
     */
    public function exclude(array $resources): static
    {
        $this->excludedResources = $resources;

        return $this;
    }

    /**
     * Check if global search is enabled.
     */
    public function isEnabled(): bool
    {
        return $this->enabled;
    }

    /**
     * Check if AI is enabled for search.
     */
    public function usesAI(): bool
    {
        return $this->useAI;
    }

    /**
     * Get limit per resource.
     */
    public function getLimit(): int
    {
        return $this->limit;
    }

    /**
     * Get maximum total results.
     */
    public function getMaxResults(): int
    {
        return $this->maxResults;
    }

    /**
     * Get debounce delay.
     */
    public function getDebounce(): int
    {
        return $this->debounce;
    }

    /**
     * Get keyboard shortcut.
     */
    public function getShortcut(): string
    {
        return $this->shortcut;
    }

    /**
     * Get custom endpoint.
     */
    public function getEndpoint(): ?string
    {
        return $this->endpoint;
    }

    /**
     * Get custom search handler.
     */
    public function getSearchHandler(): ?Closure
    {
        return $this->searchHandler;
    }

    /**
     * Get excluded resources.
     *
     * @return array<class-string>
     */
    public function getExcludedResources(): array
    {
        return $this->excludedResources;
    }

    /**
     * Convert to array for frontend.
     *
     * @return array<string, mixed>
     */
    public function toArray(): array
    {
        return [
            'enabled' => $this->enabled,
            'useAI' => $this->useAI,
            'limit' => $this->limit,
            'maxResults' => $this->maxResults,
            'debounce' => $this->debounce,
            'shortcut' => $this->shortcut,
            'endpoint' => $this->endpoint,
        ];
    }
}
</file>

<file path="src/Contracts/AIProvider.php">
<?php

declare(strict_types=1);

namespace Laravilt\AI\Contracts;

interface AIProvider
{
    /**
     * Get the provider name identifier
     */
    public function getName(): string;

    /**
     * Get the display label for the provider
     */
    public function getLabel(): string;

    /**
     * Get available models for this provider
     *
     * @return array<string, string>
     */
    public function getModels(): array;

    /**
     * Get the default model for this provider
     */
    public function getDefaultModel(): string;

    /**
     * Check if the provider is configured and ready
     */
    public function isConfigured(): bool;

    /**
     * Send a chat completion request
     *
     * @param  array<int, array{role: string, content: string}>  $messages
     * @param  array<string, mixed>  $options
     * @return array{content: string, usage: array{prompt_tokens: int, completion_tokens: int, total_tokens: int}}
     */
    public function chat(array $messages, array $options = []): array;

    /**
     * Send a chat completion with tool calling support
     *
     * @param  array<int, array{role: string, content: string}>  $messages
     * @param  array<int, array<string, mixed>>  $tools
     * @param  array<string, mixed>  $options
     * @return array{content: ?string, tool_calls: ?array<int, array{id: string, name: string, arguments: array<string, mixed>}>, usage: array<string, int>}
     */
    public function chatWithTools(array $messages, array $tools, array $options = []): array;

    /**
     * Stream a chat completion
     *
     * @param  array<int, array{role: string, content: string}>  $messages
     * @param  array<string, mixed>  $options
     * @return \Generator<string>
     */
    public function streamChat(array $messages, array $options = []): \Generator;

    /**
     * Get configuration array for frontend
     *
     * @return array<string, mixed>
     */
    public function toArray(): array;
}
</file>

<file path="src/Http/Controllers/AIController.php">
<?php

declare(strict_types=1);

namespace Laravilt\AI\Http\Controllers;

use Illuminate\Http\JsonResponse;
use Illuminate\Http\Request;
use Illuminate\Routing\Controller;
use Illuminate\Support\Facades\DB;
use Laravilt\AI\AIManager;
use Laravilt\AI\Models\AISession;
use Symfony\Component\HttpFoundation\StreamedResponse;

class AIController extends Controller
{
    public function __construct(
        protected AIManager $aiManager
    ) {}

    public function config(): JsonResponse
    {
        return response()->json($this->aiManager->toArray());
    }

    public function chat(Request $request): JsonResponse
    {
        $request->validate([
            'messages' => 'required|array',
            'messages.*.role' => 'required|string|in:system,user,assistant',
            'messages.*.content' => 'required|string',
            'provider' => 'nullable|string',
            'model' => 'nullable|string',
            'session_id' => 'nullable|string',
        ]);

        $provider = $this->aiManager->provider($request->input('provider'));

        $response = $provider->chat(
            $request->input('messages'),
            [
                'model' => $request->input('model'),
            ]
        );

        // Save to session if provided
        if ($sessionId = $request->input('session_id')) {
            $this->saveToSession($sessionId, $request->input('messages'), $response);
        }

        return response()->json($response);
    }

    public function stream(Request $request): StreamedResponse
    {
        $request->validate([
            'messages' => 'required|array',
            'messages.*.role' => 'required|string|in:system,user,assistant',
            'messages.*.content' => 'required|string',
            'provider' => 'nullable|string',
            'model' => 'nullable|string',
        ]);

        $provider = $this->aiManager->provider($request->input('provider'));

        return response()->stream(function () use ($provider, $request) {
            $generator = $provider->streamChat(
                $request->input('messages'),
                [
                    'model' => $request->input('model'),
                ]
            );

            foreach ($generator as $chunk) {
                echo "data: ".json_encode(['content' => $chunk])."\n\n";
                ob_flush();
                flush();
            }

            echo "data: [DONE]\n\n";
            ob_flush();
            flush();
        }, 200, [
            'Content-Type' => 'text/event-stream',
            'Cache-Control' => 'no-cache',
            'Connection' => 'keep-alive',
            'X-Accel-Buffering' => 'no',
        ]);
    }

    public function sessions(Request $request): JsonResponse
    {
        $sessions = AISession::query()
            ->where('user_id', $request->user()?->id)
            ->orderByDesc('updated_at')
            ->limit(50)
            ->get();

        return response()->json([
            'sessions' => $sessions,
        ]);
    }

    public function session(string $id): JsonResponse
    {
        $session = AISession::findOrFail($id);

        return response()->json([
            'session' => $session,
        ]);
    }

    public function createSession(Request $request): JsonResponse
    {
        $request->validate([
            'title' => 'nullable|string|max:255',
            'provider' => 'nullable|string',
            'model' => 'nullable|string',
        ]);

        $session = AISession::create([
            'id' => (string) \Illuminate\Support\Str::uuid(),
            'user_id' => $request->user()?->id,
            'title' => $request->input('title', 'New Chat'),
            'provider' => $request->input('provider'),
            'model' => $request->input('model'),
            'messages' => [],
            'metadata' => [],
        ]);

        return response()->json([
            'session' => $session,
        ]);
    }

    public function updateSession(Request $request, string $id): JsonResponse
    {
        $session = AISession::findOrFail($id);

        $request->validate([
            'title' => 'nullable|string|max:255',
            'messages' => 'nullable|array',
        ]);

        $session->update($request->only(['title', 'messages']));

        return response()->json([
            'session' => $session->fresh(),
        ]);
    }

    public function deleteSession(string $id): JsonResponse
    {
        $session = AISession::findOrFail($id);
        $session->delete();

        return response()->json([
            'success' => true,
        ]);
    }

    /**
     * @param  array<int, array{role: string, content: string}>  $messages
     * @param  array<string, mixed>  $response
     */
    protected function saveToSession(string $sessionId, array $messages, array $response): void
    {
        $session = AISession::find($sessionId);

        if (! $session) {
            return;
        }

        $currentMessages = $session->messages ?? [];

        // Add user message (last one in messages array)
        $lastUserMessage = collect($messages)->last(fn ($m) => $m['role'] === 'user');
        if ($lastUserMessage) {
            $currentMessages[] = $lastUserMessage;
        }

        // Add assistant response
        $currentMessages[] = [
            'role' => 'assistant',
            'content' => $response['content'],
        ];

        $session->update([
            'messages' => $currentMessages,
        ]);
    }
}
</file>

<file path="src/Http/Controllers/GlobalSearchController.php">
<?php

declare(strict_types=1);

namespace Laravilt\AI\Http\Controllers;

use Illuminate\Http\JsonResponse;
use Illuminate\Http\Request;
use Illuminate\Routing\Controller;
use Laravilt\AI\GlobalSearch;

class GlobalSearchController extends Controller
{
    public function __construct(
        protected GlobalSearch $globalSearch
    ) {}

    public function search(Request $request): JsonResponse
    {
        $query = $request->input('query', '');
        $useAI = $request->boolean('useAI', true);

        $results = $this->globalSearch
            ->useAI($useAI)
            ->search($query);

        return response()->json([
            'results' => $results,
            'query' => $query,
        ]);
    }

    public function resources(): JsonResponse
    {
        return response()->json([
            'resources' => collect($this->globalSearch->getResources())->map(function ($resource) {
                return [
                    'resource' => $resource['resource'],
                    'label' => $resource['label'],
                    'icon' => $resource['icon'],
                ];
            }),
        ]);
    }
}
</file>

<file path="src/Models/AISession.php">
<?php

declare(strict_types=1);

namespace Laravilt\AI\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;

class AISession extends Model
{
    public $incrementing = false;

    protected $keyType = 'string';

    protected $table = 'ai_sessions';

    protected $fillable = [
        'id',
        'user_id',
        'title',
        'provider',
        'model',
        'messages',
        'metadata',
    ];

    protected $casts = [
        'messages' => 'array',
        'metadata' => 'array',
    ];

    /**
     * @return BelongsTo<Model, self>
     */
    public function user(): BelongsTo
    {
        $userModel = config('auth.providers.users.model', 'App\\Models\\User');

        return $this->belongsTo($userModel, 'user_id');
    }

    public function addMessage(string $role, string $content): static
    {
        $messages = $this->messages ?? [];
        $messages[] = [
            'role' => $role,
            'content' => $content,
        ];
        $this->messages = $messages;
        $this->save();

        return $this;
    }

    public function clearMessages(): static
    {
        $this->messages = [];
        $this->save();

        return $this;
    }

    public function getLastMessage(): ?array
    {
        $messages = $this->messages ?? [];

        return end($messages) ?: null;
    }

    public function getMessageCount(): int
    {
        return count($this->messages ?? []);
    }
}
</file>

<file path="src/Providers/AnthropicProvider.php">
<?php

declare(strict_types=1);

namespace Laravilt\AI\Providers;

use Generator;
use Laravilt\AI\Enums\AnthropicModel;

class AnthropicProvider extends BaseProvider
{
    public function getName(): string
    {
        return 'anthropic';
    }

    public function getLabel(): string
    {
        return 'Anthropic';
    }

    public function getModels(): array
    {
        return AnthropicModel::toArray();
    }

    public function getDefaultModel(): string
    {
        return AnthropicModel::CLAUDE_SONNET_4->value;
    }

    protected function getBaseUrl(): string
    {
        return 'https://api.anthropic.com/v1';
    }

    protected function getHeaders(): array
    {
        return [
            'x-api-key' => $this->getApiKey(),
            'anthropic-version' => '2023-06-01',
            'Content-Type' => 'application/json',
        ];
    }

    public function chat(array $messages, array $options = []): array
    {
        // Extract system message if present
        $system = null;
        $filteredMessages = [];

        foreach ($messages as $message) {
            if ($message['role'] === 'system') {
                $system = $message['content'];
            } else {
                $filteredMessages[] = $message;
            }
        }

        $payload = [
            'model' => $options['model'] ?? $this->getModel(),
            'messages' => $filteredMessages,
            'max_tokens' => $options['max_tokens'] ?? $this->getMaxTokens(),
        ];

        if ($system) {
            $payload['system'] = $system;
        }

        // Anthropic doesn't use temperature for some models
        if (! str_starts_with($payload['model'], 'claude-3-opus')) {
            $payload['temperature'] = $options['temperature'] ?? $this->getTemperature();
        }

        $response = $this->http()->post('/messages', $payload);

        $data = $response->json();

        return [
            'content' => $data['content'][0]['text'] ?? '',
            'usage' => [
                'prompt_tokens' => $data['usage']['input_tokens'] ?? 0,
                'completion_tokens' => $data['usage']['output_tokens'] ?? 0,
                'total_tokens' => ($data['usage']['input_tokens'] ?? 0) + ($data['usage']['output_tokens'] ?? 0),
            ],
        ];
    }

    public function chatWithTools(array $messages, array $tools, array $options = []): array
    {
        // Extract system message if present
        $system = null;
        $filteredMessages = [];

        foreach ($messages as $message) {
            if ($message['role'] === 'system') {
                $system = $message['content'];
            } else {
                $filteredMessages[] = $message;
            }
        }

        $formattedTools = array_map(function ($tool) {
            return [
                'name' => $tool['name'],
                'description' => $tool['description'] ?? '',
                'input_schema' => $tool['parameters'] ?? ['type' => 'object', 'properties' => []],
            ];
        }, $tools);

        $payload = [
            'model' => $options['model'] ?? $this->getModel(),
            'messages' => $filteredMessages,
            'tools' => $formattedTools,
            'max_tokens' => $options['max_tokens'] ?? $this->getMaxTokens(),
        ];

        if ($system) {
            $payload['system'] = $system;
        }

        $response = $this->http()->post('/messages', $payload);

        $data = $response->json();

        $content = null;
        $toolCalls = null;

        foreach ($data['content'] ?? [] as $block) {
            if ($block['type'] === 'text') {
                $content = $block['text'];
            } elseif ($block['type'] === 'tool_use') {
                $toolCalls = $toolCalls ?? [];
                $toolCalls[] = [
                    'id' => $block['id'],
                    'name' => $block['name'],
                    'arguments' => $block['input'] ?? [],
                ];
            }
        }

        return [
            'content' => $content,
            'tool_calls' => $toolCalls,
            'usage' => [
                'prompt_tokens' => $data['usage']['input_tokens'] ?? 0,
                'completion_tokens' => $data['usage']['output_tokens'] ?? 0,
                'total_tokens' => ($data['usage']['input_tokens'] ?? 0) + ($data['usage']['output_tokens'] ?? 0),
            ],
        ];
    }

    public function streamChat(array $messages, array $options = []): Generator
    {
        // Extract system message if present
        $system = null;
        $filteredMessages = [];

        foreach ($messages as $message) {
            if ($message['role'] === 'system') {
                $system = $message['content'];
            } else {
                $filteredMessages[] = $message;
            }
        }

        $payload = [
            'model' => $options['model'] ?? $this->getModel(),
            'messages' => $filteredMessages,
            'max_tokens' => $options['max_tokens'] ?? $this->getMaxTokens(),
            'stream' => true,
        ];

        if ($system) {
            $payload['system'] = $system;
        }

        $response = $this->http()->withOptions(['stream' => true])
            ->post('/messages', $payload);

        $body = $response->toPsrResponse()->getBody();

        while (! $body->eof()) {
            $line = $this->readLine($body);
            if (str_starts_with($line, 'data: ')) {
                $data = substr($line, 6);
                $json = json_decode($data, true);

                if (isset($json['type']) && $json['type'] === 'content_block_delta') {
                    if (isset($json['delta']['text'])) {
                        yield $json['delta']['text'];
                    }
                }
            }
        }
    }

    /**
     * @param  \Psr\Http\Message\StreamInterface  $stream
     */
    private function readLine($stream): string
    {
        $line = '';
        while (! $stream->eof()) {
            $char = $stream->read(1);
            if ($char === "\n") {
                break;
            }
            $line .= $char;
        }

        return trim($line);
    }
}
</file>

<file path="src/Providers/BaseProvider.php">
<?php

declare(strict_types=1);

namespace Laravilt\AI\Providers;

use BackedEnum;
use Illuminate\Http\Client\PendingRequest;
use Illuminate\Support\Facades\Http;
use Laravilt\AI\Contracts\AIProvider;

abstract class BaseProvider implements AIProvider
{
    protected ?string $apiKey = null;

    protected ?string $model = null;

    protected ?string $baseUrl = null;

    protected float $temperature = 0.7;

    protected int $maxTokens = 2048;

    protected bool $enabled = true;

    public function __construct()
    {
        $this->loadFromConfig();
    }

    /**
     * Load configuration from laravilt-ai config file.
     */
    protected function loadFromConfig(): void
    {
        $providerName = $this->getName();
        $config = config("laravilt-ai.providers.{$providerName}", []);

        if (! empty($config['api_key'])) {
            $this->apiKey = $config['api_key'];
        }

        if (! empty($config['model'])) {
            $this->model = $config['model'];
        }

        if (! empty($config['base_url'])) {
            $this->baseUrl = $config['base_url'];
        }

        if (isset($config['temperature'])) {
            $this->temperature = (float) $config['temperature'];
        }

        if (isset($config['max_tokens'])) {
            $this->maxTokens = (int) $config['max_tokens'];
        }
    }

    public function apiKey(string $apiKey): static
    {
        $this->apiKey = $apiKey;

        return $this;
    }

    public function model(string|BackedEnum $model): static
    {
        $this->model = $model instanceof BackedEnum ? $model->value : $model;

        return $this;
    }

    public function enabled(bool $enabled = true): static
    {
        $this->enabled = $enabled;

        return $this;
    }

    public function disabled(): static
    {
        $this->enabled = false;

        return $this;
    }

    public function isEnabled(): bool
    {
        return $this->enabled;
    }

    public function baseUrl(string $baseUrl): static
    {
        $this->baseUrl = $baseUrl;

        return $this;
    }

    public function temperature(float $temperature): static
    {
        $this->temperature = $temperature;

        return $this;
    }

    public function maxTokens(int $maxTokens): static
    {
        $this->maxTokens = $maxTokens;

        return $this;
    }

    public function isConfigured(): bool
    {
        return $this->enabled && ! empty($this->apiKey);
    }

    protected function getApiKey(): string
    {
        return $this->apiKey ?? '';
    }

    protected function getModel(): string
    {
        return $this->model ?? $this->getDefaultModel();
    }

    protected function getTemperature(): float
    {
        return $this->temperature;
    }

    protected function getMaxTokens(): int
    {
        return $this->maxTokens;
    }

    abstract protected function getBaseUrl(): string;

    protected function http(): PendingRequest
    {
        return Http::baseUrl($this->baseUrl ?? $this->getBaseUrl())
            ->withHeaders($this->getHeaders())
            ->timeout(120);
    }

    /**
     * @return array<string, string>
     */
    abstract protected function getHeaders(): array;

    public function toArray(): array
    {
        return [
            'name' => $this->getName(),
            'label' => $this->getLabel(),
            'models' => $this->getModels(),
            'defaultModel' => $this->getDefaultModel(),
            'configured' => $this->isConfigured(),
        ];
    }
}
</file>

<file path="src/Providers/DeepSeekProvider.php">
<?php

declare(strict_types=1);

namespace Laravilt\AI\Providers;

use Generator;
use Laravilt\AI\Enums\DeepSeekModel;

class DeepSeekProvider extends BaseProvider
{
    public function getName(): string
    {
        return 'deepseek';
    }

    public function getLabel(): string
    {
        return 'DeepSeek';
    }

    public function getModels(): array
    {
        return DeepSeekModel::toArray();
    }

    public function getDefaultModel(): string
    {
        return DeepSeekModel::DEEPSEEK_CHAT->value;
    }

    protected function getBaseUrl(): string
    {
        return 'https://api.deepseek.com/v1';
    }

    protected function getHeaders(): array
    {
        return [
            'Authorization' => 'Bearer '.$this->getApiKey(),
            'Content-Type' => 'application/json',
        ];
    }

    public function chat(array $messages, array $options = []): array
    {
        $response = $this->http()->post('/chat/completions', [
            'model' => $options['model'] ?? $this->getModel(),
            'messages' => $messages,
            'temperature' => $options['temperature'] ?? $this->getTemperature(),
            'max_tokens' => $options['max_tokens'] ?? $this->getMaxTokens(),
        ]);

        $data = $response->json();

        return [
            'content' => $data['choices'][0]['message']['content'] ?? '',
            'usage' => [
                'prompt_tokens' => $data['usage']['prompt_tokens'] ?? 0,
                'completion_tokens' => $data['usage']['completion_tokens'] ?? 0,
                'total_tokens' => $data['usage']['total_tokens'] ?? 0,
            ],
        ];
    }

    public function chatWithTools(array $messages, array $tools, array $options = []): array
    {
        $formattedTools = array_map(function ($tool) {
            return [
                'type' => 'function',
                'function' => [
                    'name' => $tool['name'],
                    'description' => $tool['description'] ?? '',
                    'parameters' => $tool['parameters'] ?? ['type' => 'object', 'properties' => []],
                ],
            ];
        }, $tools);

        $response = $this->http()->post('/chat/completions', [
            'model' => $options['model'] ?? $this->getModel(),
            'messages' => $messages,
            'tools' => $formattedTools,
            'tool_choice' => $options['tool_choice'] ?? 'auto',
            'temperature' => $options['temperature'] ?? $this->getTemperature(),
            'max_tokens' => $options['max_tokens'] ?? $this->getMaxTokens(),
        ]);

        $data = $response->json();
        $message = $data['choices'][0]['message'] ?? [];

        $toolCalls = null;
        if (isset($message['tool_calls'])) {
            $toolCalls = array_map(function ($call) {
                return [
                    'id' => $call['id'],
                    'name' => $call['function']['name'],
                    'arguments' => json_decode($call['function']['arguments'], true) ?? [],
                ];
            }, $message['tool_calls']);
        }

        return [
            'content' => $message['content'] ?? null,
            'tool_calls' => $toolCalls,
            'usage' => [
                'prompt_tokens' => $data['usage']['prompt_tokens'] ?? 0,
                'completion_tokens' => $data['usage']['completion_tokens'] ?? 0,
                'total_tokens' => $data['usage']['total_tokens'] ?? 0,
            ],
        ];
    }

    public function streamChat(array $messages, array $options = []): Generator
    {
        $response = $this->http()->withOptions(['stream' => true])
            ->post('/chat/completions', [
                'model' => $options['model'] ?? $this->getModel(),
                'messages' => $messages,
                'temperature' => $options['temperature'] ?? $this->getTemperature(),
                'max_tokens' => $options['max_tokens'] ?? $this->getMaxTokens(),
                'stream' => true,
            ]);

        $body = $response->toPsrResponse()->getBody();

        while (! $body->eof()) {
            $line = $this->readLine($body);
            if (str_starts_with($line, 'data: ')) {
                $data = substr($line, 6);
                if ($data === '[DONE]') {
                    break;
                }
                $json = json_decode($data, true);
                if (isset($json['choices'][0]['delta']['content'])) {
                    yield $json['choices'][0]['delta']['content'];
                }
            }
        }
    }

    /**
     * @param  \Psr\Http\Message\StreamInterface  $stream
     */
    private function readLine($stream): string
    {
        $line = '';
        while (! $stream->eof()) {
            $char = $stream->read(1);
            if ($char === "\n") {
                break;
            }
            $line .= $char;
        }

        return trim($line);
    }
}
</file>

<file path="src/Providers/GeminiProvider.php">
<?php

declare(strict_types=1);

namespace Laravilt\AI\Providers;

use Generator;
use Laravilt\AI\Enums\GeminiModel;

class GeminiProvider extends BaseProvider
{
    public function getName(): string
    {
        return 'gemini';
    }

    public function getLabel(): string
    {
        return 'Google Gemini';
    }

    public function getModels(): array
    {
        return GeminiModel::toArray();
    }

    public function getDefaultModel(): string
    {
        return GeminiModel::GEMINI_2_FLASH->value;
    }

    protected function getBaseUrl(): string
    {
        return 'https://generativelanguage.googleapis.com/v1beta';
    }

    protected function getHeaders(): array
    {
        return [
            'Content-Type' => 'application/json',
        ];
    }

    public function chat(array $messages, array $options = []): array
    {
        $model = $options['model'] ?? $this->getModel();

        // Convert messages to Gemini format
        $contents = $this->convertMessages($messages);

        $response = $this->http()->post("/models/{$model}:generateContent", [
            'key' => $this->getApiKey(),
            'contents' => $contents,
            'generationConfig' => [
                'temperature' => $options['temperature'] ?? $this->getTemperature(),
                'maxOutputTokens' => $options['max_tokens'] ?? $this->getMaxTokens(),
            ],
        ]);

        $data = $response->json();

        $content = '';
        if (isset($data['candidates'][0]['content']['parts'][0]['text'])) {
            $content = $data['candidates'][0]['content']['parts'][0]['text'];
        }

        return [
            'content' => $content,
            'usage' => [
                'prompt_tokens' => $data['usageMetadata']['promptTokenCount'] ?? 0,
                'completion_tokens' => $data['usageMetadata']['candidatesTokenCount'] ?? 0,
                'total_tokens' => $data['usageMetadata']['totalTokenCount'] ?? 0,
            ],
        ];
    }

    public function chatWithTools(array $messages, array $tools, array $options = []): array
    {
        $model = $options['model'] ?? $this->getModel();

        // Convert messages to Gemini format
        $contents = $this->convertMessages($messages);

        // Convert tools to Gemini format
        $functionDeclarations = array_map(function ($tool) {
            return [
                'name' => $tool['name'],
                'description' => $tool['description'] ?? '',
                'parameters' => $tool['parameters'] ?? ['type' => 'object', 'properties' => []],
            ];
        }, $tools);

        $response = $this->http()->post("/models/{$model}:generateContent", [
            'key' => $this->getApiKey(),
            'contents' => $contents,
            'tools' => [
                ['functionDeclarations' => $functionDeclarations],
            ],
            'generationConfig' => [
                'temperature' => $options['temperature'] ?? $this->getTemperature(),
                'maxOutputTokens' => $options['max_tokens'] ?? $this->getMaxTokens(),
            ],
        ]);

        $data = $response->json();

        $content = null;
        $toolCalls = null;

        $parts = $data['candidates'][0]['content']['parts'] ?? [];
        foreach ($parts as $part) {
            if (isset($part['text'])) {
                $content = $part['text'];
            }
            if (isset($part['functionCall'])) {
                $toolCalls = $toolCalls ?? [];
                $toolCalls[] = [
                    'id' => uniqid('call_'),
                    'name' => $part['functionCall']['name'],
                    'arguments' => $part['functionCall']['args'] ?? [],
                ];
            }
        }

        return [
            'content' => $content,
            'tool_calls' => $toolCalls,
            'usage' => [
                'prompt_tokens' => $data['usageMetadata']['promptTokenCount'] ?? 0,
                'completion_tokens' => $data['usageMetadata']['candidatesTokenCount'] ?? 0,
                'total_tokens' => $data['usageMetadata']['totalTokenCount'] ?? 0,
            ],
        ];
    }

    public function streamChat(array $messages, array $options = []): Generator
    {
        $model = $options['model'] ?? $this->getModel();

        // Convert messages to Gemini format
        $contents = $this->convertMessages($messages);

        $response = $this->http()->withOptions(['stream' => true])
            ->post("/models/{$model}:streamGenerateContent", [
                'key' => $this->getApiKey(),
                'contents' => $contents,
                'generationConfig' => [
                    'temperature' => $options['temperature'] ?? $this->getTemperature(),
                    'maxOutputTokens' => $options['max_tokens'] ?? $this->getMaxTokens(),
                ],
            ]);

        $body = $response->toPsrResponse()->getBody();
        $buffer = '';

        while (! $body->eof()) {
            $buffer .= $body->read(1024);

            // Parse JSON objects from the buffer
            while (($pos = strpos($buffer, "\n")) !== false) {
                $line = substr($buffer, 0, $pos);
                $buffer = substr($buffer, $pos + 1);

                $line = trim($line);
                if (empty($line) || $line === '[' || $line === ']' || $line === ',') {
                    continue;
                }

                // Remove leading comma if present
                $line = ltrim($line, ',');

                $json = json_decode($line, true);
                if (isset($json['candidates'][0]['content']['parts'][0]['text'])) {
                    yield $json['candidates'][0]['content']['parts'][0]['text'];
                }
            }
        }
    }

    /**
     * Convert OpenAI-style messages to Gemini format
     *
     * @param  array<int, array{role: string, content: string}>  $messages
     * @return array<int, array{role: string, parts: array<int, array{text: string}>}>
     */
    private function convertMessages(array $messages): array
    {
        $contents = [];
        $systemInstruction = null;

        foreach ($messages as $message) {
            if ($message['role'] === 'system') {
                $systemInstruction = $message['content'];

                continue;
            }

            $role = match ($message['role']) {
                'assistant' => 'model',
                default => 'user',
            };

            $contents[] = [
                'role' => $role,
                'parts' => [['text' => $message['content']]],
            ];
        }

        // Prepend system instruction to first user message if exists
        if ($systemInstruction && count($contents) > 0) {
            $contents[0]['parts'][0]['text'] = $systemInstruction."\n\n".$contents[0]['parts'][0]['text'];
        }

        return $contents;
    }
}
</file>

<file path="src/Providers/OpenAIProvider.php">
<?php

declare(strict_types=1);

namespace Laravilt\AI\Providers;

use Generator;
use Laravilt\AI\Enums\OpenAIModel;

class OpenAIProvider extends BaseProvider
{
    public function getName(): string
    {
        return 'openai';
    }

    public function getLabel(): string
    {
        return 'OpenAI';
    }

    public function getModels(): array
    {
        return OpenAIModel::toArray();
    }

    public function getDefaultModel(): string
    {
        return OpenAIModel::GPT_4O_MINI->value;
    }

    protected function getBaseUrl(): string
    {
        return 'https://api.openai.com/v1';
    }

    protected function getHeaders(): array
    {
        return [
            'Authorization' => 'Bearer '.$this->getApiKey(),
            'Content-Type' => 'application/json',
        ];
    }

    public function chat(array $messages, array $options = []): array
    {
        $response = $this->http()->post('/chat/completions', [
            'model' => $options['model'] ?? $this->getModel(),
            'messages' => $messages,
            'temperature' => $options['temperature'] ?? $this->getTemperature(),
            'max_tokens' => $options['max_tokens'] ?? $this->getMaxTokens(),
        ]);

        $data = $response->json();

        return [
            'content' => $data['choices'][0]['message']['content'] ?? '',
            'usage' => [
                'prompt_tokens' => $data['usage']['prompt_tokens'] ?? 0,
                'completion_tokens' => $data['usage']['completion_tokens'] ?? 0,
                'total_tokens' => $data['usage']['total_tokens'] ?? 0,
            ],
        ];
    }

    public function chatWithTools(array $messages, array $tools, array $options = []): array
    {
        $formattedTools = array_map(function ($tool) {
            return [
                'type' => 'function',
                'function' => [
                    'name' => $tool['name'],
                    'description' => $tool['description'] ?? '',
                    'parameters' => $tool['parameters'] ?? ['type' => 'object', 'properties' => []],
                ],
            ];
        }, $tools);

        $response = $this->http()->post('/chat/completions', [
            'model' => $options['model'] ?? $this->getModel(),
            'messages' => $messages,
            'tools' => $formattedTools,
            'tool_choice' => $options['tool_choice'] ?? 'auto',
            'temperature' => $options['temperature'] ?? $this->getTemperature(),
            'max_tokens' => $options['max_tokens'] ?? $this->getMaxTokens(),
        ]);

        $data = $response->json();
        $message = $data['choices'][0]['message'] ?? [];

        $toolCalls = null;
        if (isset($message['tool_calls'])) {
            $toolCalls = array_map(function ($call) {
                return [
                    'id' => $call['id'],
                    'name' => $call['function']['name'],
                    'arguments' => json_decode($call['function']['arguments'], true) ?? [],
                ];
            }, $message['tool_calls']);
        }

        return [
            'content' => $message['content'] ?? null,
            'tool_calls' => $toolCalls,
            'usage' => [
                'prompt_tokens' => $data['usage']['prompt_tokens'] ?? 0,
                'completion_tokens' => $data['usage']['completion_tokens'] ?? 0,
                'total_tokens' => $data['usage']['total_tokens'] ?? 0,
            ],
        ];
    }

    public function streamChat(array $messages, array $options = []): Generator
    {
        $response = $this->http()->withOptions(['stream' => true])
            ->post('/chat/completions', [
                'model' => $options['model'] ?? $this->getModel(),
                'messages' => $messages,
                'temperature' => $options['temperature'] ?? $this->getTemperature(),
                'max_tokens' => $options['max_tokens'] ?? $this->getMaxTokens(),
                'stream' => true,
            ]);

        $body = $response->toPsrResponse()->getBody();

        while (! $body->eof()) {
            $line = $this->readLine($body);
            if (str_starts_with($line, 'data: ')) {
                $data = substr($line, 6);
                if ($data === '[DONE]') {
                    break;
                }
                $json = json_decode($data, true);
                if (isset($json['choices'][0]['delta']['content'])) {
                    yield $json['choices'][0]['delta']['content'];
                }
            }
        }
    }

    /**
     * @param  \Psr\Http\Message\StreamInterface  $stream
     */
    private function readLine($stream): string
    {
        $line = '';
        while (! $stream->eof()) {
            $char = $stream->read(1);
            if ($char === "\n") {
                break;
            }
            $line .= $char;
        }

        return trim($line);
    }
}
</file>

<file path="src/Tools/CreateTool.php">
<?php

declare(strict_types=1);

namespace Laravilt\AI\Tools;

use Illuminate\Database\Eloquent\Model;

class CreateTool extends Tool
{
    /** @var class-string<Model>|null */
    protected ?string $model = null;

    /** @var array<int, string> */
    protected array $fillable = [];

    /**
     * @param  class-string<Model>  $model
     */
    public function model(string $model): static
    {
        $this->model = $model;

        // Get fillable fields from model
        $instance = new $model;
        $this->fillable = $instance->getFillable();

        // Add parameters for each fillable field
        foreach ($this->fillable as $field) {
            $this->addParameter($field, 'string', "The {$field} value", false);
        }

        return $this;
    }

    /**
     * @param  array<int, string>  $fields
     */
    public function fillable(array $fields): static
    {
        $this->fillable = $fields;

        return $this;
    }

    /**
     * @param  array<string, mixed>  $arguments
     * @return array<string, mixed>
     */
    protected function handle(array $arguments): array
    {
        if (! $this->model) {
            return ['error' => 'No model specified'];
        }

        // Filter to only fillable fields
        $data = array_intersect_key($arguments, array_flip($this->fillable));

        $model = $this->model::create($data);

        return $model->toArray();
    }
}
</file>

<file path="src/Tools/DeleteTool.php">
<?php

declare(strict_types=1);

namespace Laravilt\AI\Tools;

use Illuminate\Database\Eloquent\Model;

class DeleteTool extends Tool
{
    /** @var class-string<Model>|null */
    protected ?string $model = null;

    protected bool $softDelete = true;

    /**
     * @param  class-string<Model>  $model
     */
    public function model(string $model): static
    {
        $this->model = $model;

        $this->addParameter('id', 'integer', 'The ID of the record to delete', true);

        return $this;
    }

    public function softDelete(bool $condition = true): static
    {
        $this->softDelete = $condition;

        return $this;
    }

    public function forceDelete(): static
    {
        $this->softDelete = false;

        return $this;
    }

    /**
     * @param  array<string, mixed>  $arguments
     * @return array<string, mixed>
     */
    protected function handle(array $arguments): array
    {
        if (! $this->model) {
            return ['error' => 'No model specified'];
        }

        if (empty($arguments['id'])) {
            return ['error' => 'ID is required'];
        }

        $model = $this->model::query()->find($arguments['id']);

        if (! $model instanceof Model) {
            return ['error' => 'Record not found'];
        }

        if (! $this->softDelete) {
            $model->forceDelete();
        } else {
            $model->delete();
        }

        return ['success' => true, 'message' => 'Record deleted successfully'];
    }
}
</file>

<file path="src/Tools/Tool.php">
<?php

declare(strict_types=1);

namespace Laravilt\AI\Tools;

use Closure;

abstract class Tool
{
    protected string $name;

    protected ?string $description = null;

    /** @var array<string, array<string, mixed>> */
    protected array $parameters = [];

    /** @var array<string, mixed> */
    protected array $schema = [];

    protected ?Closure $handler = null;

    public function __construct(string $name)
    {
        $this->name = $name;
    }

    public static function make(string $name): static
    {
        return new static($name); // @phpstan-ignore new.static
    }

    public function description(string $description): static
    {
        $this->description = $description;

        return $this;
    }

    /**
     * @param  array<string, array<string, mixed>>  $parameters
     */
    public function parameters(array $parameters): static
    {
        $this->parameters = $parameters;

        return $this;
    }

    public function addParameter(string $name, string $type, string $description, bool $required = false): static
    {
        $this->parameters[$name] = [
            'type' => $type,
            'description' => $description,
            'required' => $required,
        ];

        return $this;
    }

    /**
     * @param  array<string, mixed>  $schema
     */
    public function schema(array $schema): static
    {
        $this->schema = $schema;

        return $this;
    }

    public function handler(Closure $callback): static
    {
        $this->handler = $callback;

        return $this;
    }

    public function getName(): string
    {
        return $this->name;
    }

    public function getDescription(): ?string
    {
        return $this->description;
    }

    /**
     * @return array<string, array<string, mixed>>
     */
    public function getParameters(): array
    {
        return $this->parameters;
    }

    /**
     * @param  array<string, mixed>  $arguments
     */
    public function execute(array $arguments): mixed
    {
        if ($this->handler) {
            return ($this->handler)($arguments);
        }

        return $this->handle($arguments);
    }

    /**
     * @param  array<string, mixed>  $arguments
     */
    abstract protected function handle(array $arguments): mixed;

    /**
     * Export tool configuration for AI providers
     *
     * @return array<string, mixed>
     */
    public function toArray(): array
    {
        $properties = [];
        $required = [];

        foreach ($this->parameters as $name => $config) {
            $properties[$name] = [
                'type' => $config['type'],
                'description' => $config['description'],
            ];

            if ($config['required'] ?? false) {
                $required[] = $name;
            }
        }

        return [
            'name' => $this->name,
            'description' => $this->description ?? '',
            'parameters' => [
                'type' => 'object',
                'properties' => $properties,
                'required' => $required,
            ],
        ];
    }
}
</file>

<file path="src/Tools/UpdateTool.php">
<?php

declare(strict_types=1);

namespace Laravilt\AI\Tools;

use Illuminate\Database\Eloquent\Model;

class UpdateTool extends Tool
{
    /** @var class-string<Model>|null */
    protected ?string $model = null;

    /** @var array<int, string> */
    protected array $fillable = [];

    /**
     * @param  class-string<Model>  $model
     */
    public function model(string $model): static
    {
        $this->model = $model;

        // Get fillable fields from model
        $instance = new $model;
        $this->fillable = $instance->getFillable();

        // Add ID parameter
        $this->addParameter('id', 'integer', 'The ID of the record to update', true);

        // Add parameters for each fillable field
        foreach ($this->fillable as $field) {
            $this->addParameter($field, 'string', "The {$field} value", false);
        }

        return $this;
    }

    /**
     * @param  array<int, string>  $fields
     */
    public function fillable(array $fields): static
    {
        $this->fillable = $fields;

        return $this;
    }

    /**
     * @param  array<string, mixed>  $arguments
     * @return array<string, mixed>
     */
    protected function handle(array $arguments): array
    {
        if (! $this->model) {
            return ['error' => 'No model specified'];
        }

        if (empty($arguments['id'])) {
            return ['error' => 'ID is required'];
        }

        $model = $this->model::query()->find($arguments['id']);

        if (! $model instanceof Model) {
            return ['error' => 'Record not found'];
        }

        // Filter to only fillable fields
        $data = array_intersect_key($arguments, array_flip($this->fillable));

        $model->update($data);

        $freshModel = $model->fresh();

        return $freshModel ? $freshModel->toArray() : [];
    }
}
</file>

<file path="src/Agent.php">
<?php

declare(strict_types=1);

namespace Laravilt\AI;

use Laravilt\AI\Tools\Tool;

abstract class Agent
{
    protected string $name;

    protected ?string $description = null;

    protected ?string $instructions = null;

    /** @var array<int, Tool> */
    protected array $tools = [];

    /** @var array<string, mixed> */
    protected array $metadata = [];

    public function __construct(string $name)
    {
        $this->name = $name;
    }

    public static function make(string $name): static
    {
        return new static($name); // @phpstan-ignore new.static
    }

    public function description(string $description): static
    {
        $this->description = $description;

        return $this;
    }

    public function instructions(string $instructions): static
    {
        $this->instructions = $instructions;

        return $this;
    }

    /**
     * @param  array<int, Tool>  $tools
     */
    public function tools(array $tools): static
    {
        $this->tools = $tools;

        return $this;
    }

    public function addTool(Tool $tool): static
    {
        $this->tools[] = $tool;

        return $this;
    }

    /**
     * @param  array<string, mixed>  $metadata
     */
    public function metadata(array $metadata): static
    {
        $this->metadata = $metadata;

        return $this;
    }

    public function getName(): string
    {
        return $this->name;
    }

    public function getDescription(): ?string
    {
        return $this->description;
    }

    public function getInstructions(): ?string
    {
        return $this->instructions;
    }

    /**
     * @return array<int, Tool>
     */
    public function getTools(): array
    {
        return $this->tools;
    }

    /**
     * @return array<string, mixed>
     */
    public function getMetadata(): array
    {
        return $this->metadata;
    }

    /**
     * Export agent configuration for AI providers (OpenAI, Anthropic, etc.)
     *
     * @return array<string, mixed>
     */
    public function toArray(): array
    {
        return [
            'name' => $this->name,
            'description' => $this->description,
            'instructions' => $this->instructions,
            'tools' => array_map(
                fn (Tool $tool) => $tool->toArray(),
                $this->tools
            ),
            'metadata' => $this->metadata,
        ];
    }

    /**
     * Export agent configuration as JSON string
     */
    public function toJson(): string
    {
        $json = json_encode($this->toArray(), JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES);

        return $json === false ? '{}' : $json;
    }
}
</file>

<file path="src/AIAgent.php">
<?php

declare(strict_types=1);

namespace Laravilt\AI;

use Closure;
use Illuminate\Database\Eloquent\Model;
use Laravilt\AI\Tools\Tool;

/**
 * AIAgent configuration class for resources.
 * Similar to Form/Table/ApiResource configuration pattern.
 */
class AIAgent
{
    protected ?string $name = null;

    protected ?string $description = null;

    protected ?string $systemPrompt = null;

    /** @var class-string<Model>|null */
    protected ?string $model = null;

    /** @var array<int, string> */
    protected array $searchable = [];

    /** @var array<int, Tool> */
    protected array $tools = [];

    /** @var array<string, mixed> */
    protected array $metadata = [];

    protected bool $canCreate = true;

    protected bool $canUpdate = true;

    protected bool $canDelete = true;

    protected bool $canQuery = true;

    protected ?Closure $customHandler = null;

    public static function make(): static
    {
        return new static;
    }

    public function name(string $name): static
    {
        $this->name = $name;

        return $this;
    }

    public function description(string $description): static
    {
        $this->description = $description;

        return $this;
    }

    public function systemPrompt(string $prompt): static
    {
        $this->systemPrompt = $prompt;

        return $this;
    }

    /**
     * @param  class-string<Model>  $model
     */
    public function model(string $model): static
    {
        $this->model = $model;

        return $this;
    }

    /**
     * @param  array<int, string>  $columns
     */
    public function searchable(array $columns): static
    {
        $this->searchable = $columns;

        return $this;
    }

    /**
     * @param  array<int, Tool>  $tools
     */
    public function tools(array $tools): static
    {
        $this->tools = $tools;

        return $this;
    }

    public function addTool(Tool $tool): static
    {
        $this->tools[] = $tool;

        return $this;
    }

    /**
     * @param  array<string, mixed>  $metadata
     */
    public function metadata(array $metadata): static
    {
        $this->metadata = $metadata;

        return $this;
    }

    public function canCreate(bool $condition = true): static
    {
        $this->canCreate = $condition;

        return $this;
    }

    public function canUpdate(bool $condition = true): static
    {
        $this->canUpdate = $condition;

        return $this;
    }

    public function canDelete(bool $condition = true): static
    {
        $this->canDelete = $condition;

        return $this;
    }

    public function canQuery(bool $condition = true): static
    {
        $this->canQuery = $condition;

        return $this;
    }

    public function handler(Closure $handler): static
    {
        $this->customHandler = $handler;

        return $this;
    }

    // Getters

    public function getName(): ?string
    {
        return $this->name;
    }

    public function getDescription(): ?string
    {
        return $this->description;
    }

    public function getSystemPrompt(): ?string
    {
        return $this->systemPrompt;
    }

    /**
     * @return class-string<Model>|null
     */
    public function getModel(): ?string
    {
        return $this->model;
    }

    /**
     * @return array<int, string>
     */
    public function getSearchable(): array
    {
        return $this->searchable;
    }

    /**
     * @return array<int, Tool>
     */
    public function getTools(): array
    {
        return $this->tools;
    }

    /**
     * @return array<string, mixed>
     */
    public function getMetadata(): array
    {
        return $this->metadata;
    }

    public function getCanCreate(): bool
    {
        return $this->canCreate;
    }

    public function getCanUpdate(): bool
    {
        return $this->canUpdate;
    }

    public function getCanDelete(): bool
    {
        return $this->canDelete;
    }

    public function getCanQuery(): bool
    {
        return $this->canQuery;
    }

    public function getHandler(): ?Closure
    {
        return $this->customHandler;
    }

    /**
     * Convert to ResourceAgent instance for execution
     */
    public function toResourceAgent(): ResourceAgent
    {
        $agent = ResourceAgent::make($this->name ?? 'resource_agent');

        if ($this->description) {
            $agent->description($this->description);
        }

        if ($this->systemPrompt) {
            $agent->instructions($this->systemPrompt);
        }

        if ($this->model) {
            $agent->model($this->model);
        }

        if (! empty($this->tools)) {
            $agent->tools($this->tools);
        }

        if (! empty($this->metadata)) {
            $agent->metadata($this->metadata);
        }

        return $agent;
    }

    /**
     * Export configuration for frontend
     *
     * @return array<string, mixed>
     */
    public function toArray(): array
    {
        return [
            'name' => $this->name,
            'description' => $this->description,
            'model' => $this->model,
            'searchable' => $this->searchable,
            'capabilities' => [
                'create' => $this->canCreate,
                'update' => $this->canUpdate,
                'delete' => $this->canDelete,
                'query' => $this->canQuery,
            ],
            'tools' => array_map(fn (Tool $tool) => $tool->toArray(), $this->tools),
            'metadata' => $this->metadata,
        ];
    }
}
</file>

<file path="src/AIManager.php">
<?php

declare(strict_types=1);

namespace Laravilt\AI;

use InvalidArgumentException;
use Laravilt\AI\Contracts\AIProvider;
use Laravilt\AI\Providers\AnthropicProvider;
use Laravilt\AI\Providers\DeepSeekProvider;
use Laravilt\AI\Providers\GeminiProvider;
use Laravilt\AI\Providers\OpenAIProvider;

class AIManager
{
    /** @var array<string, AIProvider> */
    protected array $providers = [];

    protected ?string $defaultProvider = null;

    /** @var array<string, class-string<AIProvider>> */
    protected array $availableProviders = [
        'openai' => OpenAIProvider::class,
        'anthropic' => AnthropicProvider::class,
        'gemini' => GeminiProvider::class,
        'deepseek' => DeepSeekProvider::class,
    ];

    public function __construct()
    {
        $this->loadFromConfig();
    }

    protected function loadFromConfig(): void
    {
        $config = config('laravilt-ai', []);

        // Load default provider
        $this->defaultProvider = $config['default'] ?? null;

        // Load provider configurations
        foreach ($config['providers'] ?? [] as $name => $providerConfig) {
            if (empty($providerConfig['api_key'])) {
                continue;
            }

            $provider = $this->createProvider($name, $providerConfig);
            if ($provider) {
                $this->providers[$name] = $provider;
            }
        }
    }

    /**
     * @param  array<string, mixed>  $config
     */
    protected function createProvider(string $name, array $config): ?AIProvider
    {
        $providerClass = $this->availableProviders[$name] ?? null;

        if (! $providerClass) {
            return null;
        }

        $provider = new $providerClass;

        if (isset($config['api_key'])) {
            $provider->apiKey($config['api_key']);
        }

        if (isset($config['model'])) {
            $provider->model($config['model']);
        }

        if (isset($config['base_url'])) {
            $provider->baseUrl($config['base_url']);
        }

        if (isset($config['temperature'])) {
            $provider->temperature((float) $config['temperature']);
        }

        if (isset($config['max_tokens'])) {
            $provider->maxTokens((int) $config['max_tokens']);
        }

        return $provider;
    }

    public function provider(?string $name = null): AIProvider
    {
        $name = $name ?? $this->defaultProvider ?? array_key_first($this->providers);

        if (! $name || ! isset($this->providers[$name])) {
            throw new InvalidArgumentException("AI provider [{$name}] is not configured.");
        }

        return $this->providers[$name];
    }

    public function hasProvider(?string $name = null): bool
    {
        if ($name === null) {
            return count($this->providers) > 0;
        }

        return isset($this->providers[$name]);
    }

    /**
     * @return array<string, AIProvider>
     */
    public function getProviders(): array
    {
        return $this->providers;
    }

    /**
     * @return array<string, class-string<AIProvider>>
     */
    public function getAvailableProviders(): array
    {
        return $this->availableProviders;
    }

    /**
     * Add a provider instance.
     */
    public function addProvider(AIProvider|string $provider, ?AIProvider $instance = null): static
    {
        if (is_string($provider) && $instance !== null) {
            // Legacy: addProvider('name', $provider)
            $this->providers[$provider] = $instance;
        } elseif ($provider instanceof AIProvider) {
            // New: addProvider($provider) - uses provider's getName()
            $this->providers[$provider->getName()] = $provider;
        }

        return $this;
    }

    /**
     * @param  class-string<AIProvider>  $class
     */
    public function registerProvider(string $name, string $class): static
    {
        $this->availableProviders[$name] = $class;

        return $this;
    }

    public function setDefault(string $name): static
    {
        $this->defaultProvider = $name;

        return $this;
    }

    /**
     * Set the default provider (alias for setDefault).
     */
    public function setDefaultProvider(string $name): static
    {
        return $this->setDefault($name);
    }

    public function isConfigured(): bool
    {
        foreach ($this->providers as $provider) {
            if ($provider->isConfigured()) {
                return true;
            }
        }

        return false;
    }

    /**
     * Get configuration array for frontend
     *
     * @return array<string, mixed>
     */
    public function toArray(): array
    {
        $providers = [];
        foreach ($this->providers as $name => $provider) {
            $providers[$name] = $provider->toArray();
        }

        return [
            'configured' => $this->isConfigured(),
            'default' => $this->defaultProvider,
            'providers' => $providers,
        ];
    }
}
</file>

<file path="src/GlobalSearch.php">
<?php

declare(strict_types=1);

namespace Laravilt\AI;

use Illuminate\Database\Eloquent\Builder;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Collection;
use Illuminate\Support\Facades\App;
use Laravel\Scout\Searchable;

class GlobalSearch
{
    /** @var array<int, array{resource: string, model: class-string<Model>, searchable: array<int, string>, label: string, icon: ?string, url: string}> */
    protected array $resources = [];

    protected ?AIManager $aiManager = null;

    protected int $limit = 5;

    protected bool $useAI = true;

    public function __construct()
    {
        $this->aiManager = App::make(AIManager::class);
    }

    /**
     * @param  class-string<Model>  $model
     * @param  array<int, string>  $searchable
     */
    public function registerResource(
        string $resource,
        string $model,
        array $searchable,
        string $label,
        ?string $icon = null,
        string $url = ''
    ): static {
        $this->resources[] = [
            'resource' => $resource,
            'model' => $model,
            'searchable' => $searchable,
            'label' => $label,
            'icon' => $icon,
            'url' => $url,
        ];

        return $this;
    }

    public function limit(int $limit): static
    {
        $this->limit = $limit;

        return $this;
    }

    public function useAI(bool $useAI = true): static
    {
        $this->useAI = $useAI;

        return $this;
    }

    /**
     * @return Collection<int, array{resource: string, label: string, icon: ?string, results: Collection}>
     */
    public function search(string $query): Collection
    {
        if (empty(trim($query))) {
            return collect();
        }

        // Check if AI is configured and should be used
        if ($this->useAI && $this->aiManager?->isConfigured()) {
            return $this->searchWithAI($query);
        }

        return $this->searchDirect($query);
    }

    /**
     * @return Collection<int, array{resource: string, label: string, icon: ?string, results: Collection}>
     */
    protected function searchDirect(string $query): Collection
    {
        $results = collect();

        foreach ($this->resources as $resource) {
            /** @var Model $modelInstance */
            $modelInstance = new $resource['model'];

            // Check if model uses Scout
            if ($this->modelUsesScout($modelInstance)) {
                $items = $this->searchWithScout($modelInstance, $query, $resource['searchable']);
            } else {
                $items = $this->searchWithDatabase($modelInstance, $query, $resource['searchable']);
            }

            if ($items->isNotEmpty()) {
                $results->push([
                    'resource' => $resource['resource'],
                    'label' => $resource['label'],
                    'icon' => $resource['icon'],
                    'url' => $resource['url'],
                    'results' => $items->map(function ($item) use ($resource) {
                        return $this->formatResult($item, $resource);
                    }),
                ]);
            }
        }

        return $results;
    }

    /**
     * Check if query is a natural language question.
     */
    protected function isQuestion(string $query): bool
    {
        $questionPatterns = [
            '/^(what|which|who|whom|whose|where|when|why|how|can|could|would|should|is|are|was|were|do|does|did|have|has|had|find|show|get|list|give)/i',
            '/\?$/',
            '/(highest|lowest|most|least|top|bottom|best|worst|maximum|minimum|max|min|biggest|smallest|largest|first|last|recent|latest|oldest|newest)/i',
        ];

        foreach ($questionPatterns as $pattern) {
            if (preg_match($pattern, $query)) {
                return true;
            }
        }

        return false;
    }

    /**
     * @return Collection<int, array{resource: string, label: string, icon: ?string, results: Collection}>
     */
    protected function searchWithAI(string $query): Collection
    {
        try {
            $provider = $this->aiManager->provider();

            // Check if this is a natural language question that needs tool-based query
            if ($this->isQuestion($query)) {
                return $this->searchWithAITools($query, $provider);
            }

            // Otherwise, use AI to extract search terms
            return $this->searchWithAITermExtraction($query, $provider);
        } catch (\Exception $e) {
            // Fallback to direct search on error
            return $this->searchDirect($query);
        }
    }

    /**
     * Search using AI with tools for natural language questions.
     *
     * @return Collection<int, array{resource: string, label: string, icon: ?string, results: Collection}>
     */
    protected function searchWithAITools(string $query, $provider): Collection
    {
        // Build tools for each resource
        $tools = [];
        $resourceMap = [];

        foreach ($this->resources as $resource) {
            $toolName = 'query_'.str_replace('-', '_', $resource['resource']);
            $resourceMap[$toolName] = $resource;

            // Get model columns for better context
            $modelInstance = new $resource['model'];
            $table = $modelInstance->getTable();

            $tools[] = [
                'name' => $toolName,
                'description' => "Query {$resource['label']} from the database. Table: {$table}. Searchable columns: ".implode(', ', $resource['searchable']),
                'parameters' => [
                    'type' => 'object',
                    'properties' => [
                        'search' => [
                            'type' => 'string',
                            'description' => 'Search term to filter results (searches in: '.implode(', ', $resource['searchable']).')',
                        ],
                        'orderBy' => [
                            'type' => 'string',
                            'description' => 'Column name to sort by (e.g., price, name, created_at)',
                        ],
                        'orderDirection' => [
                            'type' => 'string',
                            'enum' => ['asc', 'desc'],
                            'description' => 'Sort direction: asc for ascending, desc for descending',
                        ],
                        'limit' => [
                            'type' => 'integer',
                            'description' => 'Maximum number of results to return (default: '.$this->limit.')',
                        ],
                    ],
                    'required' => [],
                ],
            ];
        }

        $systemPrompt = "You are a database query assistant. Given a user's question, determine which tool to use and with what parameters to answer their question. Always use tools to fetch data - never make up answers.

For questions about 'highest', 'most expensive', 'maximum', etc: use orderBy with desc direction and limit 1.
For questions about 'lowest', 'cheapest', 'minimum', etc: use orderBy with asc direction and limit 1.
For questions about 'top N' or 'best N': use appropriate ordering with limit N.
For search questions: use the search parameter with relevant terms.";

        $response = $provider->chatWithTools([
            ['role' => 'system', 'content' => $systemPrompt],
            ['role' => 'user', 'content' => $query],
        ], $tools, ['max_tokens' => 500]);

        $results = collect();

        if (! empty($response['tool_calls'])) {
            foreach ($response['tool_calls'] as $toolCall) {
                $toolName = $toolCall['name'];
                $arguments = $toolCall['arguments'];

                if (isset($resourceMap[$toolName])) {
                    $resource = $resourceMap[$toolName];
                    $items = $this->executeQueryTool($resource, $arguments);

                    if ($items->isNotEmpty()) {
                        $results->push([
                            'resource' => $resource['resource'],
                            'label' => $resource['label'],
                            'icon' => $resource['icon'],
                            'url' => $resource['url'],
                            'aiAnswer' => $response['content'] ?? null,
                            'results' => $items->map(function ($item) use ($resource) {
                                return $this->formatResult($item, $resource);
                            }),
                        ]);
                    }
                }
            }
        }

        // If no tool calls, fall back to term extraction
        if ($results->isEmpty()) {
            return $this->searchWithAITermExtraction($query, $provider);
        }

        return $results;
    }

    /**
     * Execute a query tool with the given arguments.
     *
     * @param  array{resource: string, model: class-string<Model>, searchable: array<int, string>, label: string, icon: ?string, url: string}  $resource
     * @param  array<string, mixed>  $arguments
     */
    protected function executeQueryTool(array $resource, array $arguments): Collection
    {
        $query = $resource['model']::query();

        // Apply search
        if (! empty($arguments['search']) && ! empty($resource['searchable'])) {
            $search = $arguments['search'];
            $query->where(function ($q) use ($search, $resource) {
                foreach ($resource['searchable'] as $column) {
                    $q->orWhere($column, 'like', "%{$search}%");
                }
            });
        }

        // Apply ordering
        if (! empty($arguments['orderBy'])) {
            $direction = $arguments['orderDirection'] ?? 'asc';
            if (! in_array($direction, ['asc', 'desc'])) {
                $direction = 'asc';
            }
            $query->orderBy($arguments['orderBy'], $direction);
        }

        // Apply limit
        $limit = $arguments['limit'] ?? $this->limit;
        $query->limit($limit);

        return $query->get();
    }

    /**
     * Search using AI to extract search terms.
     *
     * @return Collection<int, array{resource: string, label: string, icon: ?string, results: Collection}>
     */
    protected function searchWithAITermExtraction(string $query, $provider): Collection
    {
        // Build context about available resources
        $resourceContext = collect($this->resources)->map(function ($r) {
            return "- {$r['label']}: searchable fields are ".implode(', ', $r['searchable']);
        })->implode("\n");

        $response = $provider->chat([
            [
                'role' => 'system',
                'content' => "You are a search assistant. Given a user query, extract the search terms and identify which resource they might be looking for. Available resources:\n{$resourceContext}\n\nRespond with JSON: {\"terms\": [\"search terms\"], \"resource\": \"resource_name or null for all\"}",
            ],
            [
                'role' => 'user',
                'content' => $query,
            ],
        ], ['max_tokens' => 100]);

        $parsed = json_decode($response['content'], true);
        $searchTerms = $parsed['terms'] ?? [$query];
        $targetResource = $parsed['resource'] ?? null;

        // Search with extracted terms
        return $this->searchDirectWithTerms(implode(' ', $searchTerms), $targetResource);
    }

    /**
     * @return Collection<int, array{resource: string, label: string, icon: ?string, results: Collection}>
     */
    protected function searchDirectWithTerms(string $query, ?string $targetResource = null): Collection
    {
        $results = collect();

        foreach ($this->resources as $resource) {
            // Skip if targeting specific resource and this isn't it
            if ($targetResource && $resource['resource'] !== $targetResource) {
                continue;
            }

            /** @var Model $modelInstance */
            $modelInstance = new $resource['model'];

            if ($this->modelUsesScout($modelInstance)) {
                $items = $this->searchWithScout($modelInstance, $query, $resource['searchable']);
            } else {
                $items = $this->searchWithDatabase($modelInstance, $query, $resource['searchable']);
            }

            if ($items->isNotEmpty()) {
                $results->push([
                    'resource' => $resource['resource'],
                    'label' => $resource['label'],
                    'icon' => $resource['icon'],
                    'url' => $resource['url'],
                    'results' => $items->map(function ($item) use ($resource) {
                        return $this->formatResult($item, $resource);
                    }),
                ]);
            }
        }

        return $results;
    }

    protected function modelUsesScout(Model $model): bool
    {
        return in_array(Searchable::class, class_uses_recursive($model));
    }

    /**
     * @param  array<int, string>  $searchable
     */
    protected function searchWithScout(Model $model, string $query, array $searchable): Collection
    {
        /** @phpstan-ignore-next-line */
        return $model::search($query)->take($this->limit)->get();
    }

    /**
     * @param  array<int, string>  $searchable
     */
    protected function searchWithDatabase(Model $model, string $query, array $searchable): Collection
    {
        return $model->newQuery()
            ->where(function (Builder $builder) use ($query, $searchable) {
                foreach ($searchable as $column) {
                    $builder->orWhere($column, 'LIKE', "%{$query}%");
                }
            })
            ->limit($this->limit)
            ->get();
    }

    /**
     * @param  array{resource: string, model: class-string<Model>, searchable: array<int, string>, label: string, icon: ?string, url: string}  $resource
     * @return array{id: mixed, title: string, subtitle: ?string, url: string}
     */
    protected function formatResult(Model $item, array $resource): array
    {
        $titleColumn = $resource['searchable'][0] ?? 'id';
        $subtitleColumn = $resource['searchable'][1] ?? null;

        return [
            'id' => $item->getKey(),
            'title' => (string) ($item->{$titleColumn} ?? $item->getKey()),
            'subtitle' => $subtitleColumn ? (string) ($item->{$subtitleColumn} ?? null) : null,
            'url' => str_replace('{id}', (string) $item->getKey(), $resource['url']),
        ];
    }

    /**
     * @return array<int, array{resource: string, model: class-string<Model>, searchable: array<int, string>, label: string, icon: ?string, url: string}>
     */
    public function getResources(): array
    {
        return $this->resources;
    }
}
</file>

<file path="src/ResourceAgent.php">
<?php

declare(strict_types=1);

namespace Laravilt\AI;

use Illuminate\Database\Eloquent\Model;
use Laravilt\AI\Tools\CreateTool;
use Laravilt\AI\Tools\DeleteTool;
use Laravilt\AI\Tools\QueryTool;
use Laravilt\AI\Tools\UpdateTool;

class ResourceAgent extends Agent
{
    /** @var class-string<Model> */
    protected string $model;

    protected bool $autoGenerateTools = true;

    /**
     * @param  class-string<Model>  $model
     */
    public function model(string $model): static
    {
        $this->model = $model;

        if ($this->autoGenerateTools) {
            $this->generateTools();
        }

        return $this;
    }

    public function autoGenerateTools(bool $condition = true): static
    {
        $this->autoGenerateTools = $condition;

        return $this;
    }

    protected function generateTools(): void
    {
        $modelName = class_basename($this->model);
        $resourceName = str($modelName)->plural()->lower()->toString();

        // Query tool
        $this->addTool(
            QueryTool::make("query_{$resourceName}")
                ->description("Query and search {$resourceName}")
                ->model($this->model)
        );

        // Create tool
        $this->addTool(
            CreateTool::make("create_{$modelName}")
                ->description("Create a new {$modelName}")
                ->model($this->model)
        );

        // Update tool
        $this->addTool(
            UpdateTool::make("update_{$modelName}")
                ->description("Update an existing {$modelName}")
                ->model($this->model)
        );

        // Delete tool
        $this->addTool(
            DeleteTool::make("delete_{$modelName}")
                ->description("Delete a {$modelName}")
                ->model($this->model)
        );
    }

    /**
     * @return class-string<Model>
     */
    public function getModel(): string
    {
        return $this->model;
    }
}
</file>

<file path="tests/Feature/DebugTest.php">
<?php

it('will not use debugging functions', function () {
    expect(['dd', 'dump', 'ray'])->each->not->toBeUsed();
});
</file>

<file path="tests/Pest.php">
<?php

use Laravilt\AI\Tests\TestCase;

uses(TestCase::class)->in(__DIR__);
</file>

<file path="tests/TestCase.php">
<?php

namespace Laravilt\AI\Tests;

use Illuminate\Foundation\Testing\RefreshDatabase;
use Orchestra\Testbench\TestCase as Orchestra;

class TestCase extends Orchestra
{
    use RefreshDatabase;

    protected function setUp(): void
    {
        parent::setUp();

        $this->loadMigrationsFrom(__DIR__.'/../database/migrations');
    }

    protected function getPackageProviders($app): array
    {
        return [
            \Laravilt\AI\AIServiceProvider::class,
        ];
    }

    protected function getEnvironmentSetUp($app): void
    {
        config()->set('database.default', 'sqlite');
        config()->set('database.connections.sqlite.database', ':memory:');
        config()->set('app.key', 'base64:'.base64_encode(random_bytes(32)));

        // Set up AI config for testing
        config()->set('laravilt-ai.providers.openai', [
            'api_key' => 'test-key',
            'model' => 'gpt-4o-mini',
        ]);
    }
}
</file>

<file path=".gitignore">
.idea
.phpunit.cache
.phpunit.result.cache
.DS_Store
Thumbs.db
/vendor/
/node_modules/
/.vscode/
composer.lock
package-lock.json
*.log
.env
.env.backup
.env.production
/dist/
/build/
</file>

<file path="CHANGELOG.md">
# Changelog

All notable changes to `Ai` will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

### Added
- Initial release

### Changed

### Deprecated

### Removed

### Fixed

### Security
</file>

<file path="CODE_OF_CONDUCT.md">
# Contributor Covenant Code of Conduct

## Our Pledge

We as members, contributors, and leaders pledge to make participation in our
community a harassment-free experience for everyone, regardless of age, body
size, visible or invisible disability, ethnicity, sex characteristics, gender
identity and expression, level of experience, education, socio-economic status,
nationality, personal appearance, race, religion, or sexual identity
and orientation.

We pledge to act and interact in ways that contribute to an open, welcoming,
diverse, inclusive, and healthy community.

## Our Standards

Examples of behavior that contributes to a positive environment for our
community include:

* Demonstrating empathy and kindness toward other people
* Being respectful of differing opinions, viewpoints, and experiences
* Giving and gracefully accepting constructive feedback
* Accepting responsibility and apologizing to those affected by our mistakes,
  and learning from the experience
* Focusing on what is best not just for us as individuals, but for the
  overall community

Examples of unacceptable behavior include:

* The use of sexualized language or imagery, and sexual attention or
  advances of any kind
* Trolling, insulting or derogatory comments, and personal or political attacks
* Public or private harassment
* Publishing others' private information, such as a physical or email
  address, without their explicit permission
* Other conduct which could reasonably be considered inappropriate in a
  professional setting

## Enforcement Responsibilities

Community leaders are responsible for clarifying and enforcing our standards of
acceptable behavior and will take appropriate and fair corrective action in
response to any behavior that they deem inappropriate, threatening, offensive,
or harmful.

## Scope

This Code of Conduct applies within all community spaces, and also applies when
an individual is officially representing the community in public spaces.

## Enforcement

Instances of abusive, harassing, or otherwise unacceptable behavior may be
reported to the community leaders responsible for enforcement.

All complaints will be reviewed and investigated promptly and fairly.

All community leaders are obligated to respect the privacy and security of the
reporter of any incident.

## Attribution

This Code of Conduct is adapted from the [Contributor Covenant](https://www.contributor-covenant.org),
version 2.0, available at https://www.contributor-covenant.org/version/2/0/code_of_conduct.html.
</file>

<file path="LICENSE.md">
MIT License

Copyright (c) 2025 Fady Mondy

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
</file>

<file path="phpstan.neon">
includes:
    - phpstan-baseline.neon

parameters:
    level: 5
    paths:
        - src
    tmpDir: build/phpstan
    checkOctaneCompatibility: true
    checkModelProperties: true
    checkMissingIterableValueType: false
</file>

<file path="phpunit.xml">
<?xml version="1.0" encoding="UTF-8"?>
<phpunit xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:noNamespaceSchemaLocation="https://schema.phpunit.de/11.0/phpunit.xsd"
         bootstrap="vendor/autoload.php"
         colors="true"
>
    <testsuites>
        <testsuite name="Test Suite">
            <directory suffix="Test.php">./tests</directory>
        </testsuite>
    </testsuites>
    <coverage>
        <report>
            <html outputDirectory="build/coverage"/>
            <text outputFile="build/coverage.txt"/>
            <clover outputFile="build/logs/clover.xml"/>
        </report>
    </coverage>
    <source>
        <include>
            <directory suffix=".php">./src</directory>
        </include>
    </source>
</phpunit>
</file>

<file path="pint.json">
{
    "preset": "laravel",
    "rules": {
        "simplified_null_return": true,
        "braces": false,
        "new_with_braces": {
            "anonymous_class": false,
            "named_class": false
        }
    }
}
</file>

<file path="testbench.yaml">
providers:
  - Laravilt\Ai\AiServiceProvider

workbench:
  welcome: false
  discovers:
    web: true
    api: true
    commands: true
    components: true
</file>

<file path="vite.config.ts">
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import tailwindcss from '@tailwindcss/vite'
import { resolve } from 'path'

export default defineConfig({
    plugins: [vue(), tailwindcss()],
    build: {
        lib: {
            entry: resolve(__dirname, 'resources/js/app.ts'),
            name: 'LaraviltAI',
            fileName: (format) => `ai.${format}.js`,
        },
        rollupOptions: {
            external: ['vue', '@inertiajs/vue3'],
            output: {
                globals: {
                    vue: 'Vue',
                    '@inertiajs/vue3': 'Inertia',
                },
            },
        },
        outDir: 'dist',
        emptyOutDir: true,
    },
    resolve: {
        alias: {
            '@': resolve(__dirname, 'resources/js'),
        },
    },
})
</file>

<file path="vite.plugin.js">
import { resolve } from 'path';

export default function AiPlugin() {
    const pluginPath = resolve(__dirname);

    return {
        name: 'ai-plugin',
        config: () => ({
            build: {
                rollupOptions: {
                    input: {
                        'ai': resolve(pluginPath, 'resources/js/app.js'),
                    },
                    output: {
                        entryFileNames: 'js/[name].js',
                        chunkFileNames: 'js/[name].js',
                        assetFileNames: (assetInfo) => {
                            if (assetInfo.name.endsWith('.css')) {
                                return 'css/[name][extname]';
                            }
                            return 'assets/[name][extname]';
                        },
                    },
                },
                outDir: resolve(pluginPath, 'dist'),
                emptyOutDir: true,
            },
        }),
    };
}
</file>

<file path="config/laravilt-ai.php">
<?php

return [
    /*
    |--------------------------------------------------------------------------
    | Default AI Provider
    |--------------------------------------------------------------------------
    |
    | The default AI provider to use when none is specified.
    |
    */
    'default' => env('LARAVILT_AI_PROVIDER', 'openai'),

    /*
    |--------------------------------------------------------------------------
    | AI Providers Configuration
    |--------------------------------------------------------------------------
    |
    | Configure your AI providers here. Each provider requires an API key
    | and can have optional settings like model, temperature, etc.
    |
    */
    'providers' => [
        'openai' => [
            'api_key' => env('OPENAI_API_KEY'),
            'model' => env('OPENAI_MODEL', 'gpt-4o-mini'),
            'base_url' => env('OPENAI_BASE_URL'),
            'temperature' => env('OPENAI_TEMPERATURE', 0.7),
            'max_tokens' => env('OPENAI_MAX_TOKENS', 2048),
        ],

        'anthropic' => [
            'api_key' => env('ANTHROPIC_API_KEY'),
            'model' => env('ANTHROPIC_MODEL', 'claude-sonnet-4-20250514'),
            'base_url' => env('ANTHROPIC_BASE_URL'),
            'temperature' => env('ANTHROPIC_TEMPERATURE', 0.7),
            'max_tokens' => env('ANTHROPIC_MAX_TOKENS', 2048),
        ],

        'gemini' => [
            'api_key' => env('GOOGLE_AI_API_KEY'),
            'model' => env('GOOGLE_AI_MODEL', 'gemini-2.0-flash-exp'),
            'base_url' => env('GOOGLE_AI_BASE_URL'),
            'temperature' => env('GOOGLE_AI_TEMPERATURE', 0.7),
            'max_tokens' => env('GOOGLE_AI_MAX_TOKENS', 2048),
        ],

        'deepseek' => [
            'api_key' => env('DEEPSEEK_API_KEY'),
            'model' => env('DEEPSEEK_MODEL', 'deepseek-chat'),
            'base_url' => env('DEEPSEEK_BASE_URL'),
            'temperature' => env('DEEPSEEK_TEMPERATURE', 0.7),
            'max_tokens' => env('DEEPSEEK_MAX_TOKENS', 2048),
        ],

        'perplexity' => [
            'api_key' => env('PERPLEXITY_API_KEY'),
            'model' => env('PERPLEXITY_MODEL', 'sonar'),
            'base_url' => env('PERPLEXITY_BASE_URL'),
            'temperature' => env('PERPLEXITY_TEMPERATURE', 0.7),
            'max_tokens' => env('PERPLEXITY_MAX_TOKENS', 2048),
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | Global Search Configuration
    |--------------------------------------------------------------------------
    |
    | Configure global search behavior including result limits and AI usage.
    |
    */
    'global_search' => [
        'enabled' => true,
        'limit' => 5,
        'use_ai' => true, // Use AI to understand search queries when available
    ],

    /*
    |--------------------------------------------------------------------------
    | Chat UI Configuration
    |--------------------------------------------------------------------------
    |
    | Configure the chat UI appearance and behavior.
    |
    */
    'chat' => [
        'streaming' => true,
        'max_history' => 100,
        'show_token_usage' => false,
    ],
];
</file>

<file path="routes/api.php">
<?php

use Illuminate\Support\Facades\Route;
use Laravilt\AI\Http\Controllers\AIController;
use Laravilt\AI\Http\Controllers\GlobalSearchController;

Route::middleware(['web', 'auth'])->prefix('laravilt-ai')->group(function () {
    // AI Configuration
    Route::get('/config', [AIController::class, 'config'])->name('laravilt-ai.config');

    // Chat endpoints
    Route::post('/chat', [AIController::class, 'chat'])->name('laravilt-ai.chat');
    Route::post('/stream', [AIController::class, 'stream'])->name('laravilt-ai.stream');

    // Session management
    Route::get('/sessions', [AIController::class, 'sessions'])->name('laravilt-ai.sessions');
    Route::post('/sessions', [AIController::class, 'createSession'])->name('laravilt-ai.sessions.create');
    Route::get('/sessions/{id}', [AIController::class, 'session'])->name('laravilt-ai.sessions.show');
    Route::patch('/sessions/{id}', [AIController::class, 'updateSession'])->name('laravilt-ai.sessions.update');
    Route::delete('/sessions/{id}', [AIController::class, 'deleteSession'])->name('laravilt-ai.sessions.delete');

    // Global search
    Route::get('/search', [GlobalSearchController::class, 'search'])->name('laravilt-ai.search');
    Route::get('/search/resources', [GlobalSearchController::class, 'resources'])->name('laravilt-ai.search.resources');
});
</file>

<file path="src/Commands/InstallAiCommand.php">
<?php

declare(strict_types=1);

namespace Laravilt\AI\Commands;

use Illuminate\Console\Command;
use Illuminate\Support\Facades\Artisan;
use Illuminate\Support\Facades\Process;

class InstallAiCommand extends Command
{
    protected $signature = 'laravilt:ai:install
                            {--force : Overwrite existing files}
                            {--without-migrations : Skip running migrations}';

    protected $description = 'Install Laravilt AI plugin';

    public function handle(): int
    {
        $this->info('Installing Laravilt AI plugin...');
        $this->newLine();

        $this->publishConfig();

        if (! $this->option('without-migrations')) {
            $this->runMigrations();
        }

        $this->newLine();
        $this->info('✅ Laravilt AI plugin installed successfully!');
        $this->newLine();

        return self::SUCCESS;
    }

    protected function publishConfig(): void
    {
        $this->info('Publishing configuration...');

        $params = ['--tag' => 'laravilt-ai-config'];

        if ($this->option('force')) {
            $params['--force'] = true;
        }

        Artisan::call('vendor:publish', $params, $this->output);
    }

    protected function runMigrations(): void
    {
        $this->info('Running migrations...');

        $this->call('migrate');

        $this->components->success('Migrations ran successfully!');
    }
}
</file>

<file path="src/Tools/QueryTool.php">
<?php

declare(strict_types=1);

namespace Laravilt\AI\Tools;

use Illuminate\Database\Eloquent\Model;

class QueryTool extends Tool
{
    /** @var class-string<Model>|null */
    protected ?string $model = null;

    protected int $limit = 10;

    /** @var array<int, string> */
    protected array $searchableColumns = [];

    /**
     * @param  class-string<Model>  $model
     */
    public function model(string $model): static
    {
        $this->model = $model;

        $this->addParameter('search', 'string', 'Search query', false);
        $this->addParameter('limit', 'integer', 'Maximum number of results', false);
        $this->addParameter('orderBy', 'string', 'Column to sort by', false);
        $this->addParameter('orderDirection', 'string', 'Sort direction (asc or desc)', false);

        return $this;
    }

    public function limit(int $limit): static
    {
        $this->limit = $limit;

        return $this;
    }

    /**
     * @param  array<int, string>  $columns
     */
    public function searchableColumns(array $columns): static
    {
        $this->searchableColumns = $columns;

        return $this;
    }

    /**
     * @param  array<string, mixed>  $arguments
     * @return array<int, array<string, mixed>>
     */
    protected function handle(array $arguments): array
    {
        if (! $this->model) {
            return [];
        }

        $query = $this->model::query();

        // Apply search
        if (! empty($arguments['search']) && ! empty($this->searchableColumns)) {
            $search = $arguments['search'];
            $query->where(function ($q) use ($search) {
                foreach ($this->searchableColumns as $column) {
                    $q->orWhere($column, 'like', "%{$search}%");
                }
            });
        }

        // Apply ordering
        if (! empty($arguments['orderBy'])) {
            $direction = $arguments['orderDirection'] ?? 'asc';
            // Validate sort direction
            if (!in_array($direction, ['asc', 'desc'])) {
                $direction = 'asc';
            }
            $query->orderBy($arguments['orderBy'], $direction);
        }

        // Apply limit
        $limit = $arguments['limit'] ?? $this->limit;
        $query->limit($limit);

        return $query->get()->toArray();
    }
}
</file>

<file path="src/AIServiceProvider.php">
<?php

declare(strict_types=1);

namespace Laravilt\AI;

use Illuminate\Support\Facades\App;
use Illuminate\Support\ServiceProvider;
use Laravilt\AI\Commands\InstallAiCommand;

class AIServiceProvider extends ServiceProvider
{
    public function register(): void
    {
        $this->mergeConfigFrom(__DIR__.'/../config/laravilt-ai.php', 'laravilt-ai');

        $this->app->singleton(AIManager::class, function () {
            return new AIManager;
        });

        $this->app->singleton(GlobalSearch::class, function () {
            return new GlobalSearch;
        });

        $this->app->alias(AIManager::class, 'laravilt-ai');
        $this->app->alias(GlobalSearch::class, 'laravilt-global-search');
    }

    public function boot(): void
    {
        $this->loadRoutesFrom(__DIR__.'/../routes/api.php');

        $this->loadMigrationsFrom(__DIR__.'/../database/migrations');

        $this->loadTranslationsFrom(__DIR__.'/../resources/lang', 'laravilt-ai');

        if ($this->app->runningInConsole()) {
            $this->publishes([
                __DIR__.'/../config/laravilt-ai.php' => config_path('laravilt-ai.php'),
            ], 'laravilt-ai-config');

            $this->publishes([
                __DIR__.'/../database/migrations' => database_path('migrations'),
            ], 'laravilt-ai-migrations');

            $this->publishes([
                __DIR__.'/../resources/lang' => lang_path('vendor/laravilt-ai'),
            ], 'laravilt-ai-lang');

            $this->commands([
                InstallAiCommand::class,
            ]);
        }
    }
}
</file>

<file path="composer.json">
{
    "name": "laravilt/ai",
    "description": "AI-powered search and chat for Laravilt. Supports OpenAI, Anthropic, Gemini, and DeepSeek with global search spotlight and chat UI.",
    "version": "1.0.0",
    "type": "library",
    "license": "MIT",
    "keywords": [
        "laravel",
        "laravilt",
        "ai",
        "openai",
        "anthropic",
        "gemini",
        "deepseek",
        "global-search",
        "spotlight",
        "chat"
    ],
    "authors": [
        {
            "name": "Fady Mondy",
            "email": "info@3x1.io"
        }
    ],
    "require": {
        "php": "^8.3|^8.4",
        "spatie/laravel-package-tools": "^1.14",
        "illuminate/support": "^11.0|^12.0",
        "illuminate/http": "^11.0|^12.0",
        "illuminate/routing": "^11.0|^12.0",
        "illuminate/database": "^11.0|^12.0"
    },
    "require-dev": {
        "larastan/larastan": "^2.9||^3.0",
        "laravel/pint": "^1.14",
        "nunomaduro/collision": "^8.1.1||^7.10.0",
        "orchestra/testbench": "^10.0",
        "pestphp/pest": "^3.0",
        "pestphp/pest-plugin-arch": "^3.0",
        "pestphp/pest-plugin-laravel": "^3.0",
        "phpstan/extension-installer": "^1.3||^2.0",
        "phpstan/phpstan-deprecation-rules": "^1.1||^2.0",
        "phpstan/phpstan-phpunit": "^1.3||^2.0"
    },
    "autoload": {
        "psr-4": {
            "Laravilt\\AI\\": "src/"
        }
    },
    "autoload-dev": {
        "psr-4": {
            "Laravilt\\AI\\Tests\\": "tests/"
        }
    },
    "scripts": {
        "analyse": "vendor/bin/phpstan analyse --memory-limit=512M",
        "test": "vendor/bin/pest",
        "test-coverage": "vendor/bin/pest --coverage",
        "format": "vendor/bin/pint"
    },
    "config": {
        "sort-packages": true,
        "allow-plugins": {
            "pestphp/pest-plugin": true,
            "phpstan/extension-installer": true
        }
    },
    "extra": {
        "laravel": {
            "providers": [
                "Laravilt\\AI\\AIServiceProvider"
            ]
        }
    },
    "minimum-stability": "dev",
    "prefer-stable": true
}
</file>

<file path="package.json">
{
    "name": "@laravilt/ai",
    "version": "1.0.0",
    "description": "AI-powered search and chat for Laravilt. Supports OpenAI, Anthropic, Gemini, and DeepSeek with global search spotlight and chat UI.",
    "author": "Fady Mondy <info@3x1.io>",
    "license": "MIT",
    "type": "module",
    "main": "./dist/ai.umd.js",
    "module": "./dist/ai.es.js",
    "types": "./dist/index.d.ts",
    "exports": {
        ".": {
            "types": "./dist/index.d.ts",
            "import": "./dist/ai.es.js",
            "require": "./dist/ai.umd.js"
        },
        "./style.css": "./dist/style.css"
    },
    "files": [
        "dist",
        "resources"
    ],
    "keywords": [
        "laravilt",
        "ai",
        "openai",
        "anthropic",
        "gemini",
        "deepseek",
        "global-search",
        "spotlight",
        "chat",
        "vue",
        "vue3",
        "inertia",
        "laravel"
    ],
    "repository": {
        "type": "git",
        "url": "https://github.com/laravilt/ai"
    },
    "bugs": {
        "url": "https://github.com/laravilt/ai/issues"
    },
    "homepage": "https://laravilt.dev/ai",
    "scripts": {
        "dev": "vite",
        "build": "vite build",
        "build:types": "vue-tsc --declaration --emitDeclarationOnly --outDir dist resources/js/app.ts || true",
        "build:npm": "npm run build",
        "prepublishOnly": "npm run build:npm",
        "format": "prettier --write resources/",
        "format:check": "prettier --check resources/",
        "lint": "eslint . --fix"
    },
    "peerDependencies": {
        "@inertiajs/vue3": "^2.0.0",
        "vue": "^3.3.0"
    },
    "devDependencies": {
        "@eslint/js": "^9.19.0",
        "@tailwindcss/vite": "^4.1.11",
        "@types/node": "^22.13.5",
        "@vitejs/plugin-vue": "^6.0.0",
        "@vue/eslint-config-typescript": "^14.3.0",
        "@vueuse/core": "^14.1.0",
        "class-variance-authority": "^0.7.1",
        "clsx": "^2.1.1",
        "eslint": "^9.17.0",
        "eslint-config-prettier": "^10.0.1",
        "eslint-plugin-vue": "^9.32.0",
        "lucide-vue-next": "^0.555.0",
        "prettier": "^3.4.2",
        "prettier-plugin-organize-imports": "^4.1.0",
        "prettier-plugin-tailwindcss": "^0.6.11",
        "reka-ui": "^2.6.1",
        "tailwind-merge": "^3.4.0",
        "typescript": "^5.2.2",
        "typescript-eslint": "^8.23.0",
        "vite": "^7.0.4",
        "vue": "^3.5.13",
        "vue-tsc": "^2.2.4"
    },
    "dependencies": {
        "tailwindcss": "^4.1.1"
    },
    "optionalDependencies": {
        "@rollup/rollup-linux-x64-gnu": "4.9.5",
        "@rollup/rollup-win32-x64-msvc": "4.9.5",
        "@tailwindcss/oxide-linux-x64-gnu": "^4.0.1",
        "@tailwindcss/oxide-win32-x64-msvc": "^4.0.1",
        "lightningcss-linux-x64-gnu": "^1.29.1",
        "lightningcss-win32-x64-msvc": "^1.29.1"
    }
}
</file>

<file path="README.md">
![AI](./arts/screenshot.jpg)

# Laravilt AI

[![Latest Stable Version](https://poser.pugx.org/laravilt/ai/version.svg)](https://packagist.org/packages/laravilt/ai)
[![License](https://poser.pugx.org/laravilt/ai/license.svg)](https://packagist.org/packages/laravilt/ai)
[![Downloads](https://poser.pugx.org/laravilt/ai/d/total.svg)](https://packagist.org/packages/laravilt/ai)

A powerful AI integration package for Laravilt with support for multiple providers (OpenAI, Anthropic, Gemini, DeepSeek), global search spotlight, and chat UI.

## Features

- **Multi-Provider Support**: OpenAI, Anthropic (Claude), Google Gemini, DeepSeek
- **Global Search Spotlight**: Cmd/Ctrl+K spotlight search with AI-powered understanding
- **Chat UI**: Full-featured chat interface with session management
- **Resource AI Agents**: Configure AI capabilities per resource
- **Scout Fallback**: Automatic fallback to Laravel Scout or direct queries when no AI is configured
- **Streaming Support**: Real-time streaming responses

## Installation

```bash
composer require laravilt/ai
```

The package will automatically register its service provider.

## Configuration

Publish the config file:

```bash
php artisan vendor:publish --tag="laravilt-ai-config"
```

Add your API keys to `.env`:

```env
# Default provider
LARAVILT_AI_PROVIDER=openai

# OpenAI Configuration
OPENAI_API_KEY=your-openai-api-key
OPENAI_MODEL=gpt-4o-mini

# Anthropic Configuration
ANTHROPIC_API_KEY=your-anthropic-api-key
ANTHROPIC_MODEL=claude-sonnet-4-20250514

# Google Gemini Configuration
GOOGLE_AI_API_KEY=your-google-api-key
GOOGLE_AI_MODEL=gemini-2.0-flash-exp

# DeepSeek Configuration
DEEPSEEK_API_KEY=your-deepseek-api-key
DEEPSEEK_MODEL=deepseek-chat
```

## Quick Start

### 1. Global Search Component

Add the GlobalSearch component to your layout:

```vue
<script setup>
import { GlobalSearch } from '@laravilt/ai'
</script>

<template>
  <GlobalSearch placeholder="Search..." :use-a-i="true" />
</template>
```

The spotlight search opens with `Cmd/Ctrl+K`.

### 2. AI Chat Component

```vue
<script setup>
import { AIChat } from '@laravilt/ai'
</script>

<template>
  <AIChat :show-sidebar="true" />
</template>
```

### 3. Resource AI Configuration

Add AI capabilities to your resources:

```php
use Laravilt\AI\AIAgent;
use Laravilt\Panel\Resources\Resource;

class ProductResource extends Resource
{
    public static function ai(AIAgent $agent): AIAgent
    {
        return $agent
            ->name('product_assistant')
            ->description('AI assistant for managing products')
            ->searchable(['name', 'description', 'sku'])
            ->canCreate(true)
            ->canUpdate(true)
            ->canDelete(false)
            ->canQuery(true)
            ->systemPrompt('You are a helpful product management assistant.');
    }
}
```

## AI Providers

### OpenAI

```php
use Laravilt\AI\AIManager;

$ai = app(AIManager::class);
$response = $ai->provider('openai')->chat([
    ['role' => 'user', 'content' => 'Hello!'],
]);
```

Available models:
- `gpt-4o` - GPT-4o
- `gpt-4o-mini` - GPT-4o Mini
- `gpt-4-turbo` - GPT-4 Turbo
- `gpt-4` - GPT-4
- `gpt-3.5-turbo` - GPT-3.5 Turbo
- `o1`, `o1-mini`, `o1-preview` - O1 Models

### Anthropic (Claude)

```php
$response = $ai->provider('anthropic')->chat([
    ['role' => 'user', 'content' => 'Hello!'],
]);
```

Available models:
- `claude-sonnet-4-20250514` - Claude Sonnet 4
- `claude-opus-4-20250514` - Claude Opus 4
- `claude-3-5-sonnet-20241022` - Claude 3.5 Sonnet
- `claude-3-5-haiku-20241022` - Claude 3.5 Haiku
- `claude-3-opus-20240229` - Claude 3 Opus

### Google Gemini

```php
$response = $ai->provider('gemini')->chat([
    ['role' => 'user', 'content' => 'Hello!'],
]);
```

Available models:
- `gemini-2.0-flash-exp` - Gemini 2.0 Flash
- `gemini-1.5-pro` - Gemini 1.5 Pro
- `gemini-1.5-flash` - Gemini 1.5 Flash
- `gemini-pro` - Gemini Pro

### DeepSeek

```php
$response = $ai->provider('deepseek')->chat([
    ['role' => 'user', 'content' => 'Hello!'],
]);
```

Available models:
- `deepseek-chat` - DeepSeek Chat
- `deepseek-coder` - DeepSeek Coder
- `deepseek-reasoner` - DeepSeek R1

## Streaming Responses

```php
$ai = app(AIManager::class);
$stream = $ai->provider()->streamChat([
    ['role' => 'user', 'content' => 'Write a story'],
]);

foreach ($stream as $chunk) {
    echo $chunk;
}
```

## Tool Calling

```php
$response = $ai->provider()->chatWithTools(
    messages: [
        ['role' => 'user', 'content' => 'What is the weather in Tokyo?'],
    ],
    tools: [
        [
            'name' => 'get_weather',
            'description' => 'Get weather information for a city',
            'parameters' => [
                'type' => 'object',
                'properties' => [
                    'city' => ['type' => 'string', 'description' => 'City name'],
                ],
                'required' => ['city'],
            ],
        ],
    ]
);

if ($response['tool_calls']) {
    foreach ($response['tool_calls'] as $call) {
        // Handle tool call
        $result = handleToolCall($call['name'], $call['arguments']);
    }
}
```

## Global Search

Register resources for global search:

```php
use Laravilt\AI\GlobalSearch;

app(GlobalSearch::class)
    ->registerResource(
        resource: 'products',
        model: Product::class,
        searchable: ['name', 'description', 'sku'],
        label: 'Products',
        icon: 'Package',
        url: '/admin/products/{id}'
    )
    ->limit(5)
    ->useAI(true);
```

## Vue Composables

### useAI

```typescript
import { useAI } from '@laravilt/ai'

const {
  config,
  loading,
  selectedProvider,
  selectedModel,
  availableProviders,
  availableModels,
  loadConfig,
  chat,
  streamChat,
} = useAI()

// Load configuration
await loadConfig()

// Send a message
const response = await chat([
  { role: 'user', content: 'Hello!' }
])

// Stream a response
for await (const chunk of streamChat(messages)) {
  console.log(chunk)
}
```

### useGlobalSearch

```typescript
import { useGlobalSearch } from '@laravilt/ai'

const {
  query,
  results,
  loading,
  useAI,
  search,
  debouncedSearch,
  clear,
} = useGlobalSearch()

// Perform search
await search('product name')

// Or with debounce
await debouncedSearch('product name', 300)
```

## API Endpoints

The package provides the following API endpoints:

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/laravilt-ai/config` | Get AI configuration |
| POST | `/laravilt-ai/chat` | Send chat message |
| POST | `/laravilt-ai/stream` | Stream chat response |
| GET | `/laravilt-ai/sessions` | List chat sessions |
| POST | `/laravilt-ai/sessions` | Create new session |
| GET | `/laravilt-ai/sessions/{id}` | Get session |
| PATCH | `/laravilt-ai/sessions/{id}` | Update session |
| DELETE | `/laravilt-ai/sessions/{id}` | Delete session |
| GET | `/laravilt-ai/search` | Global search |

## Testing

```bash
composer test
```

## Code Style

```bash
composer format
```

## Static Analysis

```bash
composer analyse
```

## License

The MIT License (MIT). Please see [License File](LICENSE.md) for more information.
</file>

</files>
